# QC_Portal 機能設計書

## 1. トップページ機能

- `GET /` でトップページを表示する
- データベースからランダムに1問取得し、問題のプレビューを表示する
- プレビューには問題タイトル・本文・空欄・選択肢を含む
- 問題プレビューから該当問題の詳細ページへ遷移できる
- 問題選択画面への導線を提供する

## 2. ユーザー認証機能

### 2.1 ユーザー登録
- `POST /auth/register` でユーザー登録を行う
- ユーザーID・パスワード・メールアドレスを入力として受け付ける
- パスワードはbcryptでハッシュ化して`users`テーブルに保存する
- 登録成功時、自動的にログイン状態にする

### 2.2 ログイン
- `POST /auth/login` でログイン処理を行う
- Passport.js (LocalStrategy) を使用して認証する
- ユーザーIDとパスワードで照合し、bcryptでハッシュ比較を行う
- ログイン成功時、`last_login_at`を更新する
- セッションはexpress-sessionとexpress-mysql-sessionでMySQL上に管理する

### 2.3 ログアウト
- `POST /auth/logout` でセッションを破棄しログアウトする

### 2.4 認証状態確認
- `GET /auth/status` で現在の認証状態をJSON形式で返却する
- フロントエンドからの非同期リクエストで認証状態を確認する用途

## 3. 問題選択機能

### 3.1 問題選択画面の表示
- `GET /questions/select` で問題選択画面を表示する
- `SELECT_category_tree.sql` を使用してカテゴリツリー(大分類・小分類)を取得する
- ユーザーは以下の条件で問題を絞り込める
  - 級 (testlevel)
  - 大分類 (quiz_large_category)
  - 小分類 (quiz_small_category)

### 3.2 テスト開始
- `POST /questions/start` で選択された条件に基づきテストを開始する
- `SELECT_question_BY_conditions.sql` で条件に合致する問題IDリストを取得する
- 取得した問題IDリストをセッションに格納する
- 最初の問題ページへリダイレクトする

## 4. 問題出題・表示機能

### 4.1 問題詳細の表示
- `GET /questions/:question_id` で個別の問題を表示する
- `SELECT_question_detail_WITH_BLANKS.sql` で問題の詳細情報を取得する
  - 問題タイトル・本文・画像データ
  - 空欄情報 (quiz_blanks)
  - 各空欄の選択肢 (quiz_choices)
  - 解説・解説画像
- 数式はKaTeXでレンダリングする
- 画像データ(longblob)がある場合は問題内に表示する

### 4.2 出題モード
- **単問モード**: 個別の問題IDを指定して1問だけ表示する
- **連続モード**: セッションに格納された問題IDリストに基づき連続して出題する
  - 現在の問題番号と総問題数を表示する
  - 次の問題への遷移を制御する

### 4.3 中断再開機能
- ログインユーザーが連続出題モードで途中離脱した場合、中断地点から再開できる
- `GET /questions/:question_id` で問題を表示するたびに `req.session.currentIndex` を現在の問題位置で更新する
- `GET /questions/select` の表示時にセッション内の出題データ (`questionIds`, `currentIndex`) を確認する
  - ログイン中かつ未完了の出題セッションが存在する場合、再開情報 (`resumeData`) をビューに渡す
- 問題選択画面の「出題開始」ボタンの右隣に「中断したところから再開（N/M問目から）」ボタンを表示する
  - ボタンは `resumeData` が存在する場合のみ描画される
  - クリックすると中断した問題ページへ直接遷移する
- 全問完了時の処理
  - 最後の問題で終了オーバーレイの「閉じる」ボタンを押すと `POST /questions/complete` を呼び出す
  - `POST /questions/complete` はセッションから `questionIds` と `currentIndex` を削除し、`req.session.save()` で明示的に保存する
  - セッションクリア完了後に問題選択画面へリダイレクトする
  - これにより全問完了後は再開ボタンが表示されない
- 新たに「出題開始」を押した場合、既存の出題セッションは上書きされる
- 「ログイン状態を保持する」にチェックを入れたユーザーはセッションが30日間持続するため、ブラウザを閉じても再開可能

## 5. 解答・正誤判定機能

- `POST /questions/answer` で解答を送信する
- 各空欄に対してユーザーが選択した選択肢IDを受け取る
- `SELECT_correct_answer_BY_blank_id.sql` で空欄ごとの正解選択肢を取得する
- 選択された選択肢と正解を比較し正誤を判定する
- 判定結果をJSON形式で返却する
  - 各空欄の正誤結果
  - 正解の選択肢情報
- 認証済みユーザーの場合、解答結果を`user_responses`テーブルに記録する
  - `INSERT_user_response.sql` でuser_id, blank_id, selected_choice_id, is_correctを保存する

## 6. アカウント管理機能

### 6.1 解答履歴の取得
- `GET /account/history/:testlevel` で級別の解答履歴を取得する
- `SELECT_user_history_BY_testlevel.sql` でROW_NUMBERによるランク付けされた履歴を返却する
- カテゴリ情報(大分類・小分類)を含めて返却する
  - `quiz_small_category`, `quiz_large_category` をJOINして取得
  - カテゴリ順(大分類num → 小分類num → question_id → blank_id)でソートする
- 認証済みユーザーのみアクセス可能
- レスポンスは空欄(blank_id)単位で、各空欄に対し直近3回の解答結果を含む

### 6.1.1 学習履歴の表示形式
- 表(テーブル)形式で表示する
  - 列: 問題ID、空欄、カテゴリ分野(小分類名)、習熟度
  - 行: 空欄(blank_id)ごとに1行
- 習熟度マークの判定ロジック
  - **◎ (mastery-excellent)**: 直近2回すべて正解 — 習熟
  - **〇 (mastery-good)**: 直近1回正解 — 正解
  - **× (mastery-incorrect)**: 直近1回が不正解 — 要復習
- 判定優先順: × → ◎ → 〇
- テーブル上部に習熟度マークの凡例を表示する

### 6.2 学習統計の取得
- `GET /account/stats/total-learned` でユーザーの総学習数を取得する
- `SELECT_total_learned_count_BY_user.sql` で解答済みの問題数(重複除外)を返却する

### 6.3 達成度の取得
- `GET /account/achievement/:testlevel` で級別の達成度情報を取得する

### 6.4 問題閲覧
- `GET /account/view/:question_id` でアカウント画面から個別の問題を閲覧する

### 6.5 アカウント削除
- `DELETE /account/delete` でアカウントを削除する
- 認証済みユーザーのみ実行可能

### 6.6 プロフィール編集
- `POST /account/profile/update` でプロフィール情報を更新する
- 更新可能な情報:
  - ユーザー名 (`user_name`)
  - 第一志望級 (`want_grade1`)
  - 第二志望級 (`want_grade2`)
  - 予定試験日 (`scheduled_exam_date`)
- 認証済みユーザーのみ実行可能
- 更新成功時、更新されたプロフィール情報をJSON形式で返却する

### 6.7 問題チェック機能
- `POST /account/question-check` で問題にチェックフラグを付ける
- `DELETE /account/question-check` で問題のチェックフラグを削除する
- `GET /account/question-check/:questionId` で特定問題のチェック状態を取得する
- チェックフラグの種類:
  - **yellow (黄)**: 後で見直す
  - **green (緑)**: 理解済み
  - **red (赤)**: 要復習
- ユーザーごとに問題の学習状態を管理する
- `user_question_checks` テーブルに保存する
- 問題選択画面や問題表示画面でチェック状態を視覚的に表示する

### 6.8 アカウント管理UI
- ナビゲーションバーからアカウント管理モーダルを開く
- モーダル内で以下の操作を行う:
  - **プロフィールタブ**: ユーザー名、志望級、試験日の編集
  - **履歴タブ**: 解答履歴の閲覧
  - **達成度タブ**: 級別の達成度グラフ
  - **活動タブ**: 学習活動グラフ（日別・週別・月別・年別）
  - **レーダーチャートタブ**: カテゴリ別正解率のレーダーチャート
  - **チェックタブ**: 問題チェック管理（黄・緑・赤フラグ別）
  - **設定タブ**: アカウント削除

## 7. 情報ページ機能

- `GET /qcis` でQC検定の概要情報ページを表示する
- `GET /statisinfo` で統計情報ページを表示する
- `GET /kiyaku` で利用規約ページを表示する
- `GET /privacy-policy` でプライバシーポリシーページを表示する

## 8. 共通UI機能

### 8.1 ナビゲーションバー
- 全ページ共通のヘッダーナビゲーション
- 認証状態に応じて表示を切り替える
  - 未ログイン時: ログインボタン
  - ログイン時: アカウントメニュー・ログアウトボタン

### 8.2 フッター
- 全ページ共通のフッター
- 利用規約・プライバシーポリシーへのリンクを含む

### 8.3 解答結果表示コンポーネント
- 解答送信後に正誤結果を表示する共通コンポーネント
- 正解/不正解の判定結果と正解情報を表示する

### 8.4 コピー防止
- `copy-protection.js` により問題コンテンツのコピーを防止する

### 8.5 ダークモード機能
- 全画面共通のテーマ切り替え機能
- ライトモード/ダークモードの2つのテーマを提供する
- ナビゲーションバーにテーマ切り替えボタンを配置する
  - ボタンアイコン: ライトモード時は月（🌙）、ダークモード時は太陽（☀️）
  - クリックでテーマを即座に切り替える
- CSS変数による実装
  - 95種類のCSS変数で全色を管理する（664箇所の色参照）
  - `:root` でライトテーマのデフォルト値を定義する
  - `[data-theme="dark"]` セレクタでダークテーマの値をオーバーライドする
- localStorageによる永続化
  - ユーザーの選択を `theme` キーで保存する
  - 次回訪問時に保存されたテーマを自動適用する
- レスポンシブデザイン対応
  - モバイル表示でもテーマボタンを最適な位置に配置する

## 9. データモデル

### 9.1 問題データ構造
- **quiz_questions**: 問題本体(タイトル, 級, 本文, 画像, 解説)
- **quiz_blanks**: 問題内の空欄(問題IDに紐づく)
- **quiz_choices**: 空欄ごとの選択肢(ラベル, 選択肢テキスト)
- **quiz_answers**: 空欄と正解選択肢の対応

### 9.2 カテゴリ構造
- **quiz_large_category**: 大分類
- **quiz_small_category**: 小分類(大分類に紐づく、出題範囲の級情報を含む)
- **theorypractice**: カテゴリ区分(理論/実践など)

### 9.3 ユーザーデータ構造
- **users**: ユーザー情報(ID, パスワードハッシュ, メール, タイムスタンプ, リセットトークン, 有効フラグ)
- **user_responses**: 解答履歴(ユーザーID, 空欄ID, 選択肢ID, 正誤, 解答日時)
- **sessions**: セッション管理(MySQLセッションストア)

## 10. セッション管理

- express-sessionとexpress-mysql-sessionを使用する
- セッションデータはMySQL上の`sessions`テーブルに永続化する
- テスト中の問題IDリストをセッションに格納し、連続出題を制御する
- 認証情報(Passportシリアライズ)をセッションに保持する

## 11. 検定シミュレーション機能

### 11.1 概要
- `GET /tools/simulate` で検定シミュレーション画面を表示する
- QC検定3〜1級の統計的検定を体験型で学習できる機能
- データベース不使用、JSONファイルによる棄却域テーブル運用
- ゲスト利用可（認証不要）

### 11.2 対応する検定（12種類）

#### 連続値の検定
- **1標本t検定 (t_1sample)**: 母平均が特定の値と異なるかを検定
- **対応ありt検定 (t_paired)**: 対応のある2群の差の平均がゼロと異なるかを検定
- **Welchのt検定 (t_welch)**: 独立な2群の母平均が等しいかを検定（等分散を仮定しない）
- **等分散t検定 (t_equal_var)**: 独立な2群の母平均が等しいかを検定（等分散を仮定）

#### 比率の検定
- **1標本比率検定 (prop_1)**: 母比率が特定の値と異なるかを検定
- **2標本比率差の検定 (prop_2)**: 2群の母比率が等しいかを検定

#### 度数の検定
- **適合度検定 (chi2_gof)**: 観測度数が期待度数に適合しているかをχ²検定
- **独立性の検定 (chi2_indep)**: 2つの変数が独立であるかをχ²検定

#### 分散の検定
- **等分散性のF検定 (f_eqvar)**: 2群の母分散が等しいかを検定
- **一元配置分散分析 (anova_oneway)**: 3群以上の母平均がすべて等しいかを検定

#### 離散の検定（正確法）
- **二項検定 (binom)**: 成功確率が特定の値と異なるかを正確法で検定
- **ポアソン検定 (poisson)**: ポアソン率が特定の値と異なるかを検定

### 11.3 API仕様

#### POST /tools/api/simulate
- 検定を実行し結果を返却する
- 入力: `{ test_type, alpha, tail, params: {...} }`
- 出力: `{ test_type, decision, stat, critical, p_value, meta, notes }`
- レートリミット: 60リクエスト/分

#### POST /tools/api/validate
- 入力値を検証しプレビュー情報を返却する
- 出力: `{ valid, errors, badges, derived }`

#### GET /tools/api/critical-values
- 棄却域テーブルから値を取得する
- クエリ: `?distribution=t&df=29&alpha=0.05&tail=two`
- 出力: `{ left, right, source }`

#### GET /tools/api/contents/templates
- 検定名・仮説テンプレートなどのUIテキストを返却する

### 11.4 UI構成（1画面統合）

#### 上部バー
- タイトル「検定シミュレーション」
- 有意水準α選択（0.10 / 0.05 / 0.01）
- 検定の方向選択（両側 / 右片側 / 左片側）
- 等分散トグル（Welch/等分散t検定切替時のみ表示）

#### 左ペイン（ウィザード）
- Q1: データの種類（計量値 / 計数値）
- Q2: 比較対象の数（1群 / 2群 / 3群以上）
- Q3: 検定の種類（Q1・Q2の選択に応じて動的に表示）
- 推奨・代替・理由のテンプレート表示

#### 右ペイン（入力・結果）
- 検定別入力カード（必須項目のみ）
- プレビューカード（自由度、標準誤差、近似条件バッジ）
- 実行ボタン
- 結論カード（2種のみ: 棄却 / 棄却できない）
- 分布グラフ（Canvas描画、棄却域・棄却域・検定統計量を可視化）
- 詳細トグル（統計量、p値、効果量などの詳細情報）

### 11.5 結論メッセージ

判定結果のメッセージは以下の2種類のみ:
- **棄却時**: 「帰無仮説を棄却。対立仮説を採用します。」
- **保留時**: 「帰無仮説を棄却できません。」

### 11.6 棄却域の取得方式

1. JSONテーブルから完全一致で取得（優先）
2. テーブルにない自由度は近隣値から線形補間
3. 大きな自由度（df > 120）はz近似にフォールバック
4. F分布など複雑なケースは数値計算でフォールバック

### 11.7 データ永続化

- **サーバ側**: 棄却域・テンプレート・プリセットはJSON静的ファイル（`data/`ディレクトリ）
- **クライアント側**: 直近入力値・設定をlocalStorageに保存（任意）
- **個人データ**: サーバへの保存なし（ゲスト利用のため）

### 11.8 ファイル構成

```
data/
├── critical_values_z.json      # 標準正規分布棄却域
├── critical_values_t.json      # t分布棄却域
├── critical_values_chi2.json   # χ²分布棄却域
├── critical_values_f.json      # F分布棄却域
├── contents_templates.json     # UIテンプレート
└── presets.json                # プリセットシナリオ

lib/statistics/
├── index.js                    # 公開API
├── distributions.js            # PDF/CDF関数
├── critical-values.js          # 棄却域取得
└── tests.js                    # 12検定ロジック

routes/tools.js                 # ルートハンドラ

views/tools/simulate.ejs        # 画面テンプレート

public/js/tools/
├── api-client.js               # API通信
├── wizard.js                   # ウィザードナビゲーション
├── input-cards.js              # 動的入力フォーム
├── graph.js                    # 分布グラフ描画
└── simulate.js                 # メインオーケストレーター
```

### 11.9 アクセシビリティ

- 重要情報はテキストでも提供（図に依存しない）
- バッジと凡例は色＋記号＋文言で冗長表現
- 近似条件のチェック結果をバッジで表示（OK / 注意 / 要修正）

## 12. 管理図 異常判定シミュレーター

### 12.1 概要
- `GET /tools/simulate` の管理図シミュレータータブで表示する
- 検定シミュレーション（タブ1）とタブ切替で共存する
- 管理図（Xbar管理図）上のネルソンルールによる異常パターンを学習できる機能
- サーバAPI不使用、全てクライアントサイドで完結する
- ゲスト利用可（認証不要）

### 12.2 ネルソンルール（全8ルール）

| ルール | 名称 | 判定条件 | 必要データ点数 |
|---|---|---|---|
| 1 | 限界線外 | 1点が3σを超えている（UCLまたはLCLの外側） | 1 |
| 2 | 連（ラン） | 中心線の片側に9点以上連続して並んでいる | 9 |
| 3 | 連続的な上昇・下降 | 6点連続で値が上昇、または下降し続けている | 6 |
| 4 | 交互の上下（ジグザグ） | 14点連続で交互に上がったり下がったりを繰り返す | 14 |
| 5 | 限界線付近の集中 | 連続する3点中、2点が2σを超えている（同じ側） | 3 |
| 6 | 1σ外への偏り | 連続する5点中、4点が1σを超えている（同じ側） | 5 |
| 7 | 中心付近への集中 | 15点連続で両側の1σ以内に収まっている | 15 |
| 8 | 1σ外への分散 | 連続する8点が1σの外側に分布している（両側） | 8 |

### 12.3 対象級によるルール制限

| 対象級 | 有効ルール |
|---|---|
| 3・4級対応 | ルール1, 2, 3 |
| 1・2級対応 | 全8ルール |

### 12.4 データ生成

- Box-Muller変換による正規分布乱数生成
- 平均(μ)=50、標準偏差(σ)=5 を基準値として使用
- 初心者モード: 25〜30点の静的データを一括生成し、50%の確率で異常を注入
- 熟練者モード: 1秒間隔でリアルタイムにデータ点を逐次生成

### 12.5 管理図描画

- Canvas APIによる直接描画（チャートライブラリ不使用）
- devicePixelRatio対応による高解像度レンダリング
- 描画要素
  - 中心線(CL): 紫色の実線
  - 管理限界線(UCL/LCL): 赤色の破線（±3σ）
  - ゾーン線: 各σ境界の点線（±1σ, ±2σ）
  - ゾーン塗り分け: A領域(2-3σ, 赤), B領域(1-2σ, 橙), C領域(0-1σ, 緑)
  - データ点: 青色の折れ線グラフ、異常該当点はハイライト表示
- 複数キャンバスをレジストリパターンで管理（初心者用・熟練者用を独立管理）

### 12.6 初心者モード

#### 出題フロー
1. 「スタート」ボタンで出題開始
2. 管理図が表示され「正常」「異常」ボタンで判定する
3. 「異常」を選んだ場合、ルール選択画面に遷移し該当ルールを選択する
4. フィードバックカードで正誤・解説を表示する
5. 「次の問題」ボタンで次の出題へ進む

#### ヒント機能（2段階）
- ヒント1回目: ゾーン線を表示する（±1σ, ±2σの境界線を可視化）
- ヒント2回目: 異常該当領域をハイライト表示する

#### フィードバックの種類
- **正解**: 正常を正しく正常と判定、または異常を正しく異常と判定しルールも正解
- **見逃し（Type II）**: 異常を「正常」と誤判定した場合
- **空振り（Type I）**: 正常を「異常」と誤判定した場合
- **ルール不正解**: 異常の検出は正しいが、該当ルールの選択を誤った場合

#### ルール選択UI
- カード形式のボタンで表示（ルール番号バッジ＋名称＋説明文）
- 対象級に応じて表示ルール数が動的に変化する

#### 統計情報
- 出題数・正解数・見逃し数・空振り数をカウント表示する
- localStorageに保存し、ブラウザを閉じても保持する（キー: `cc_beginner_stats`）
- リセットボタンで統計を初期化できる

### 12.7 熟練者モード

#### リアルタイム出題フロー
1. 「ライン開始」ボタンでデータ点の自動生成を開始する
2. 1秒間隔でデータ点が追加され、管理図がリアルタイムに更新される
3. 異常パターンが自動的に注入され、ユーザーは「異常あり！」ボタンで報告する
4. 正解・見逃し・空振りをフラッシュメッセージで即時表示する

#### ライン制御
- **一時停止**: データ点の生成を一時停止する
- **再開**: 一時停止したラインの生成を再開する
- **リセット**: ラインを停止し初期状態に戻す

#### 異常注入ロジック
- 最初の20点は正常データを生成する（ウォームアップ期間）
- 以降、10〜30点の間隔で異常パターンをランダムに注入する
- 対象級に応じた有効ルールの中からランダムに選択する
- 検出猶予: 異常開始から10データ点以内に報告しない場合「見逃し」と判定する

#### 情報バー
- 経過時間: `分:秒` 形式で表示する
- データ数: 生成済みデータ点の総数を表示する

#### 表示ウィンドウ
- 直近50点をキャンバスに描画する（古いデータ点はスクロールアウトする）

### 12.8 UI構成

#### タブ切替
- 検定シミュレーション（タブ1）と管理図シミュレーター（タブ2）をタブバーで切替する
- CSSグリッド重ね合わせ方式により、タブ切替時にフッター位置が変動しない
- タブ切替時に熟練者モードのラインを自動で一時停止/再開する
- 選択中のタブをlocalStorageに保存する（キー: `tools_active_tab`）

#### 設定バー
- モード切替: 初心者モード / 熟練者モードのトグルボタン
- 対象級: 「3・4級対応（ルール1, 2, 3）」/「1・2級対応（全8ルール）」のセレクト

### 12.9 データ永続化

- **クライアント側のみ**: サーバへのデータ保存なし
- localStorageに以下を保存する
  - 初心者モード統計: `cc_beginner_stats`
  - 選択中タブ: `tools_active_tab`

### 12.10 ファイル構成

```
public/js/tools/
├── cc-data-gen.js    # Box-Muller正規分布乱数・異常注入
├── cc-nelson.js      # ネルソンルール8種の判定エンジン
├── cc-chart.js       # Canvas管理図描画（レジストリパターン）
├── cc-beginner.js    # 初心者モード状態管理
├── cc-expert.js      # 熟練者モードリアルタイム制御
└── cc-main.js        # タブ切替・モード切替・イベント接続
```

## 13. 確率分布ファミリーマップ

### 13.1 概要
- `GET /tools/simulate` の分布ファミリーマップタブ（タブ3）で表示する
- 検定シミュレーション（タブ1）、管理図シミュレーター（タブ2）とタブ切替で共存する
- 離散分布7種（超幾何分布、ベルヌーイ分布、二項分布、多項分布、ポアソン分布、幾何分布、負の二項分布）と連続分布13種（正規分布、標準正規分布、対数正規分布、多変量正規分布、指数分布、ガンマ分布、χ²分布、t分布、F分布、ベータ分布、一様分布、ワイブル分布、コーシー分布）の計20分布の親子関係・派生関係をインタラクティブに可視化する
- サーバAPI不使用、全てクライアントサイドで完結する
- ゲスト利用可（認証不要）

### 13.2 対象分布（20分布）

#### 離散分布（7種）

| 分布名 | 記号 | 主なパラメータ |
|--------|------|----------------|
| 超幾何分布 | Hypergeometric | N（母集団）, K（成功数）, n（抽出数） |
| ベルヌーイ分布 | Bernoulli | p（成功確率） |
| 二項分布 | Binomial | n（試行回数）, p（成功確率） |
| 多項分布 | Multinomial | n（試行回数）, p₁…pₖ（各カテゴリの確率） |
| ポアソン分布 | Poisson | λ（平均発生率） |
| 幾何分布 | Geometric | p（成功確率） |
| 負の二項分布 | Negative Binomial | r（成功回数）, p（成功確率） |

#### 連続分布（13種）

| 分布名 | 記号 | 主なパラメータ |
|--------|------|----------------|
| 正規分布 | Normal | μ（平均）, σ²（分散） |
| 標準正規分布 | Z | μ=0, σ²=1 |
| 対数正規分布 | Log-Normal | μ（対数平均）, σ²（対数分散） |
| 多変量正規分布 | Multivariate Normal | μ（平均ベクトル）, Σ（共分散行列） |
| 指数分布 | Exponential | λ（率パラメータ） |
| ガンマ分布 | Gamma | α（形状）, β（率） |
| χ²分布 | Chi-squared | ν（自由度） |
| t分布 | Student's t | ν（自由度） |
| F分布 | Fisher's F | d₁, d₂（自由度） |
| ベータ分布 | Beta | α, β（形状パラメータ） |
| 一様分布 | Uniform | a（下限）, b（上限） |
| ワイブル分布 | Weibull | k（形状）, λ（尺度） |
| コーシー分布 | Cauchy | x₀（位置）, γ（尺度） |

### 13.2.1 分布間の関係性（25本）

| # | 関係 | 数式 | 説明 |
|---|------|------|------|
| 1 | Z² = χ²(1) | $Z^2 \sim \chi^2(1)$ | 標準正規変数の二乗はカイ二乗分布（自由度1）に従う |
| 2 | ΣZ² = χ²(k) | $\sum_{i=1}^{k} Z_i^2 \sim \chi^2(k)$ | k個の独立なZ²の和はカイ二乗分布（自由度k）に従う |
| 3 | t = Z/√(χ²/ν) | $t = \frac{Z}{\sqrt{\chi^2(\nu)/\nu}}$ | 標準正規変数をカイ二乗変数の平方根で割るとt分布に従う |
| 4 | F = (χ²₁/d₁)/(χ²₂/d₂) | $F = \frac{\chi^2_1/d_1}{\chi^2_2/d_2}$ | 2つの独立なカイ二乗変数の比はF分布に従う |
| 5 | 正規 → 標準正規 | $Z = \frac{X - \mu}{\sigma}$ | 正規分布を標準化すると標準正規分布に従う |
| 6 | ベルヌーイ → 二項 | $X = \sum_{i=1}^{n} X_i,\; X_i \sim \text{Bernoulli}(p)$ | n回のベルヌーイ試行の合計は二項分布に従う |
| 7 | 二項 → ポアソン | $\lim_{n\to\infty, p\to0, np=\lambda} \text{Bin}(n,p) = \text{Poi}(\lambda)$ | n→∞, p→0でnp=λ一定のとき二項分布はポアソン分布に収束する |
| 8 | 二項 → 正規 | $\text{Bin}(n,p) \approx N(np, np(1-p))$ | np≥5かつn(1-p)≥5のとき二項分布は正規分布で近似できる |
| 9 | ポアソン → 正規 | $\text{Poi}(\lambda) \approx N(\lambda, \lambda)$ | λが大きいときポアソン分布は正規分布で近似できる |
| 10 | 幾何 → 負の二項 | $\text{NB}(r,p) = \sum_{i=1}^{r} \text{Geo}(p)$ | 幾何分布のr回の合計は負の二項分布に従う |
| 11 | 二項 → 超幾何 | 非復元抽出 → 復元抽出 | 超幾何分布はN→∞で二項分布に収束する |
| 12 | ベルヌーイ → 幾何 | 初回成功までの試行回数 | 幾何分布はベルヌーイ試行の初回成功までの待ち時間 |
| 13 | 二項 → 多項 | カテゴリ数kへの一般化 | 多項分布は二項分布のk≥2カテゴリへの拡張 |
| 14 | 指数 → ガンマ | $\text{Gamma}(\alpha, \beta) = \sum_{i=1}^{\alpha} \text{Exp}(\beta)$ | α個の独立な指数分布の和はガンマ分布に従う |
| 15 | ガンマ → χ² | $\chi^2(\nu) = \text{Gamma}(\nu/2, 1/2)$ | カイ二乗分布はガンマ分布の特殊ケース |
| 16 | 指数 → ポアソン過程 | 到着間隔 | 指数分布はポアソン過程の事象間隔を表す |
| 17 | 正規 → 対数正規 | $e^X \sim \text{LogNormal}(\mu, \sigma^2),\; X \sim N(\mu, \sigma^2)$ | 正規分布に従う変数の指数関数は対数正規分布に従う |
| 18 | 正規 → 多変量正規 | 多次元への拡張 | 多変量正規分布は正規分布のベクトル値への一般化 |
| 19 | ガンマ → 指数 | $\text{Exp}(\lambda) = \text{Gamma}(1, \lambda)$ | 指数分布はガンマ分布でα=1の特殊ケース |
| 20 | ベータ → 一様 | $\text{Uniform}(0,1) = \text{Beta}(1,1)$ | 一様分布はベータ分布でα=β=1の特殊ケース |
| 21 | ガンマ → ベータ | $\frac{X_1}{X_1+X_2},\; X_i \sim \text{Gamma}$ | 2つの独立なガンマ変数の比はベータ分布に従う |
| 22 | 指数 → ワイブル | $\text{Weibull}(1, \lambda) = \text{Exp}(\lambda)$ | ワイブル分布はk=1のとき指数分布に一致する |
| 23 | t(ν=1) → コーシー | $\text{Cauchy}(0,1) = t(1)$ | コーシー分布はt分布で自由度1の特殊ケース |
| 24 | t² → F(1,ν) | $t^2(\nu) \sim F(1, \nu)$ | t分布の二乗はF分布（d₁=1）に従う |
| 25 | ベルヌーイ → ベータ | ベイズ共役事前分布 | ベータ分布はベルヌーイ分布（二項分布）の共役事前分布 |

### 13.3 関係マップ（初期画面）

#### レイアウト
- 20ノードのネットワークグラフ配置（Canvas描画）
- 離散分布グループ（左側）と連続分布グループ（右側）を大きく2領域に分割する
- 各グループ内はフォースレイアウトまたは手動配置で関係性が視覚的に把握しやすい位置に配置する
  - 離散分布グループ（7ノード）:
    - ベルヌーイ分布（起点）
    - 二項分布、幾何分布（ベルヌーイからの派生）
    - 多項分布（二項の一般化）
    - 負の二項分布（幾何の一般化）
    - ポアソン分布（二項の極限）
    - 超幾何分布（二項の非復元版）
  - 連続分布グループ（13ノード）:
    - 正規分布（中心ハブ）
    - 標準正規分布（正規の標準化）
    - 対数正規分布、多変量正規分布（正規の変種）
    - 指数分布、ガンマ分布（ガンマファミリー）
    - χ²分布（ガンマの特殊ケース）
    - t分布（標準正規とχ²の合成）
    - F分布（χ²の比）
    - ベータ分布（ガンマの比）
    - 一様分布（ベータの特殊ケース）
    - ワイブル分布（指数の一般化）
    - コーシー分布（t分布の特殊ケース）
- 離散→連続の橋渡し矢印（二項→正規、ポアソン→正規など）がグループ間を横断する

#### ノードの構成
- 各ノードは角丸カード（180×140px）で表現する
  - カラーアクセントバー（上辺）
  - 分布名ラベル
  - サブタイトル（日本語名）
  - ミニPDF/PMFサムネイル（150×70px）
  - 「クリックで詳細」テキスト

#### ノード色
- 離散分布: 寒色系
  - 超幾何分布: `#3498db`（明るい青）
  - ベルヌーイ分布: `#2980b9`（青）
  - 二項分布: `#1abc9c`（ティール）
  - 多項分布: `#16a085`（深ティール）
  - ポアソン分布: `#2c3e50`（ネイビー）
  - 幾何分布: `#8e44ad`（紫）
  - 負の二項分布: `#9b59b6`（明るい紫）
- 連続分布: 暖色系 + 既存色
  - 正規分布: `#34495e`（グレー）
  - 標準正規分布: `#5b8def`（青 — 既存Z色）
  - 対数正規分布: `#f39c12`（黄）
  - 多変量正規分布: `#7f8c8d`（グレー）
  - 指数分布: `#d35400`（深橙）
  - ガンマ分布: `#e74c3c`（赤）
  - χ²分布: `#e67e22`（橙 — 既存色）
  - t分布: `#27ae60`（緑 — 既存色）
  - F分布: `#c0392b`（赤 — 既存色）
  - ベータ分布: `#f1c40f`（金）
  - 一様分布: `#95a5a6`（シルバー）
  - ワイブル分布: `#e91e63`（ピンク）
  - コーシー分布: `#607d8b`（ブルーグレー）

#### 矢印（関係線）（25本）
- Bezier曲線で各ノード間を接続する（25本の関係矢印）
- 矢じり付きの方向付き矢印
- ラベル（関係式）を矢印の中間点にピル型バッジで表示する
- ホバー時にブランドパープル（`#8b6ccf`）でハイライトする
- クリックでアニメーションオーバーレイを起動する
- 矢印の密集を避けるため、ホバー時のみラベルを完全表示し、通常時は省略表示とする

#### ヒットテスト
- ノード: 矩形バウンディングボックスによる当たり判定
- 矢印: ラベル近傍（半径40px）およびBezier曲線への距離（閾値12px）による当たり判定
- ホバー時にカーソルをポインターに変更する
- タッチデバイス対応（touchstartイベント）

### 13.4 詳細パネル（ノードクリック時）

#### 表示切替
- ノードをクリックするとマップ領域・凡例を非表示にし、詳細パネルを表示する
- 「← マップに戻る」ボタンで元のマップ表示に復帰する

#### 構成要素
1. **ヘッダー**: 戻るボタン + 分布名タイトル
2. **フルサイズPDF/PMFグラフ**: Canvas描画（高さ350px）、軸・グリッド付き
   - 離散分布: 棒グラフ（PMF）で描画する
   - 連続分布: 曲線グラフ（PDF）で描画する
3. **パラメータ制御**:
   - 標準正規分布: パラメータ制御なし
   - 正規分布: μスライダー（-5〜5）、σスライダー（0.1〜5）
   - t分布・χ²分布: 自由度スライダー（1〜100、step: 1）
   - F分布: d₁・d₂の数値入力フィールド（1〜100）
   - ガンマ分布: αスライダー（0.1〜20）、βスライダー（0.1〜5）
   - ベータ分布: αスライダー（0.1〜10）、βスライダー（0.1〜10）
   - 指数分布: λスライダー（0.1〜5）
   - ワイブル分布: kスライダー（0.1〜5）、λスライダー（0.1〜5）
   - コーシー分布: x₀スライダー（-5〜5）、γスライダー（0.1〜5）
   - 対数正規分布: μスライダー（-2〜2）、σスライダー（0.1〜3）
   - 一様分布: aスライダー（-5〜5）、bスライダー（a〜10）
   - 多変量正規分布: 2次元ヒートマップ表示、ρスライダー（-0.99〜0.99）
   - 二項分布: nスライダー（1〜100）、pスライダー（0〜1）
   - ベルヌーイ分布: pスライダー（0〜1）
   - ポアソン分布: λスライダー（0.1〜30）
   - 幾何分布: pスライダー（0.01〜1）
   - 負の二項分布: rスライダー（1〜20）、pスライダー（0.01〜1）
   - 超幾何分布: Nスライダー（1〜100）、Kスライダー（0〜N）、nスライダー（0〜N）
   - 多項分布: カテゴリ数k選択（2〜5）、各pᵢスライダー（合計=1制約）
4. **数式カード**: KaTeXでPDF/PMFの数式をレンダリングする
5. **教育ノート**: 分布の実務的な意味・用途をQC検定の出題範囲と関連付けて解説するテキスト

#### t分布の特別表示
- 標準正規分布N(0,1)を灰色破線で固定オーバーレイする
- スライダー操作でt分布がリアルタイムに変形し、N(0,1)に収束する様子を可視化する
- n > 30 のとき「✔ n > 30: 正規分布で代用可能」の緑色メッセージを表示する

#### 二項分布の特別表示
- np≥5かつn(1-p)≥5のとき、正規近似N(np, np(1-p))を灰色破線でオーバーレイする
- 近似条件の成否をバッジで表示する

### 13.5 パラメータスライダー仕様

- 各分布の詳細パネルに対応するパラメータスライダーを表示する（13.4参照）
- `input`イベントでリアルタイム更新（requestAnimationFrameでデバウンス）
- スライダーデザイン: ブランドパープル（`#8b6ccf`）のサムネイル、紫グラデーション背景
- 整数パラメータ（自由度、試行回数など）はstep: 1、実数パラメータはstep: 0.1
- 値はlocalStorageに保存する（キー: `dm_params`）

### 13.6 分布変身アニメーション（矢印クリック時）

#### 共通仕様
- フルスクリーンモーダルオーバーレイで表示する（`position: fixed`、半透明黒背景）
- `requestAnimationFrame`ループによるスムーズアニメーション
- `easeInOutCubic`イージング関数を使用する
- 3フェーズ構成（各フェーズに対応する数式をKaTeXで動的表示）
- フェーズインジケーター（ドット3つ）を下部に表示する
- 「もう一度再生」「ステップ再生」ボタンを提供する
- Escapeキーまたは×ボタンで閉じる
- 25本すべての関係矢印にアニメーションを用意する

#### アニメーション種別

##### 形状モーフィング型（PDF/PMF形状の連続変形）
以下の関係はソース分布からターゲット分布へ形状を線形補間でモーフィングする:

| # | 関係 | 演出 | 時間 |
|---|------|------|------|
| 1 | Z² → χ²(1) | 負領域が自乗で正側へ折り畳み。`foldedPdf = normalPdf(√x)/√x` とχ²(1)の補間 | 3秒 |
| 2 | ΣZ² → χ²(k) | 自由度kを1→10で段階増加、過去の曲線を薄く残す | 3.5秒 |
| 3 | Z → t | 自由度νを1→30で変化、裾の重さが変わる過程。N(0,1)灰色破線参照 | 3秒 |
| 5 | 正規 → 標準正規 | μ→0, σ→1へ収束するアニメーション | 3秒 |
| 8 | 二項 → 正規 | 棒グラフ(PMF)がnの増加とともに正規曲線(PDF)に収束 | 3.5秒 |
| 9 | ポアソン → 正規 | λを1→50へ増加させ棒グラフが正規曲線に収束 | 3.5秒 |
| 17 | 正規 → 対数正規 | X軸にexp変換を適用し形状が右に歪む過程 | 3秒 |
| 23 | t(ν=1) → コーシー | t分布のν=1固定で重い裾を強調 | 2.5秒 |

##### パラメータ遷移型（パラメータを動かして特殊ケースを示す）
以下の関係はパラメータの連続変化でソースがターゲットの特殊ケースであることを示す:

| # | 関係 | 演出 | 時間 |
|---|------|------|------|
| 15 | ガンマ → χ² | α=ν/2, β=1/2 へパラメータを収束 | 3秒 |
| 19 | ガンマ → 指数 | αを5→1へ変化させ指数分布に収束 | 3秒 |
| 20 | ベータ → 一様 | α,βを各値→1へ変化させ一様分布に収束 | 3秒 |
| 22 | 指数 → ワイブル | kを各値→1へ変化させ指数分布に一致 | 3秒 |
| 24 | t² → F(1,ν) | t分布を二乗変換しF(1,ν)に収束 | 3秒 |

##### 合成・分解型（複数分布の合成操作を可視化）
以下の関係は複数の分布を合成してターゲット分布を構成する過程を示す:

| # | 関係 | 演出 | 時間 |
|---|------|------|------|
| 4 | χ² → F | 2つのχ²分布を左右並列表示→比率操作でFへモーフィング | 3秒 |
| 6 | ベルヌーイ → 二項 | n個のベルヌーイ試行を順次加算し棒グラフが成長 | 3.5秒 |
| 10 | 幾何 → 負の二項 | r個の幾何分布を順次合算し形状が変化 | 3秒 |
| 14 | 指数 → ガンマ | α個の指数分布を順次合算しガンマ分布に収束 | 3.5秒 |
| 21 | ガンマ → ベータ | 2つのガンマ分布の比を可視化しベータ分布に収束 | 3秒 |

##### 極限遷移型（パラメータの極限操作で収束を示す）
以下の関係はパラメータを極限方向に動かして近似・収束を示す:

| # | 関係 | 演出 | 時間 |
|---|------|------|------|
| 7 | 二項 → ポアソン | nを増加・pを減少（np=λ固定）し棒グラフがポアソンに収束 | 3.5秒 |
| 11 | 超幾何 → 二項 | Nを増加させ超幾何分布が二項分布に収束 | 3秒 |

##### 概念図型（数学的関係を図解で説明）
以下の関係は静的またはステップ図解で概念を説明する:

| # | 関係 | 演出 | 時間 |
|---|------|------|------|
| 12 | ベルヌーイ → 幾何 | ベルヌーイ試行の繰り返しを視覚化し初回成功までの待ち時間を図示 | 3秒 |
| 13 | 二項 → 多項 | 2カテゴリ→kカテゴリへの拡張を棒グラフで図示 | 3秒 |
| 16 | 指数 → ポアソン過程 | 時間軸上の事象到着と事象間隔の関係を図示 | 3秒 |
| 18 | 正規 → 多変量正規 | 1次元ベルカーブから2次元等高線ヒートマップへの拡張 | 3秒 |
| 25 | ベルヌーイ → ベータ | 事前分布→データ→事後分布のベイズ更新ステップを図示 | 3.5秒 |

#### ステップ再生
- 「ステップ再生」ボタンで進行度を0.34刻みで手動進行する
- 各フェーズの変化を個別に確認できる

### 13.7 統計関数（クライアントサイド実装）

- 外部統計ライブラリ不使用、全てJavaScriptで実装する
- Lanczos近似によるガンマ対数関数（`gammaLn`）
- ベータ関数（`betaFn`）: `gammaLn`を利用して計算する
- 連続分布の確率密度関数（PDF）:
  - `normalPdf`, `standardNormalPdf`, `logNormalPdf`, `exponentialPdf`
  - `gammaPdf`, `chi2Pdf`, `tPdf`, `fPdf`
  - `betaPdf`, `uniformPdf`, `weibullPdf`, `cauchyPdf`
  - `multivariateNormalPdf`（2次元ヒートマップ用）
- 離散分布の確率質量関数（PMF）:
  - `hypergeometricPmf`, `bernoulliPmf`, `binomialPmf`
  - `multinomialPmf`, `poissonPmf`, `geometricPmf`, `negativeBinomialPmf`
- 二項係数（`binomCoeff`）: 対数ガンマを利用したオーバーフロー対策
- 自動レンジ計算: 各分布のパラメータに応じたx軸範囲を自動決定する
- yMaxサンプリング: 400点サンプリングで最大確率密度/質量を計算する

### 13.8 タブ切替

- 検定シミュレーション（タブ1）、管理図シミュレーター（タブ2）、分布ファミリーマップ（タブ3）をタブバーで切替する
- CSSグリッド重ね合わせ方式により、タブ切替時にフッター位置が変動しない
- タブ切替時にアニメーションを自動停止する
- dmタブ選択時にマップCanvasをリサイズする（非表示状態からの復帰対応）
- 選択中のタブをlocalStorageに保存する（キー: `tools_active_tab`）

### 13.9 データ永続化

- **クライアント側のみ**: サーバへのデータ保存なし
- localStorageに以下を保存する
  - スライダー自由度値: `dm_slider_n`
  - 最後に展開したノード: `dm_last_node`
  - 各分布のパラメータ: `dm_params`

### 13.10 ファイル構成

```
public/js/tools/
├── dm-pdf.js       # PDF/PMF関数群（20分布）・レンジ計算・yMax算出
├── dm-canvas.js    # Canvas描画ツールキット（DPR対応・座標変換）
├── dm-map.js       # 関係マップ描画（20ノード・25矢印）・ヒットテスト
├── dm-detail.js    # 詳細パネル・パラメータスライダー・参照線オーバーレイ
├── dm-anim.js      # アニメーションエンジン（25種のアニメーション）
└── dm-main.js      # オーケストレーター・イベント接続・localStorage
```
