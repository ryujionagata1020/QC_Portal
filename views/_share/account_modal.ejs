<!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="accountModal" class="account-modal">
  <div class="account-modal-content account-management">
    <span class="account-modal-close" onclick="closeAccountModal()">&times;</span>

    <div class="account-modal-header">
      <h2>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†</h2>
    </div>

    <div class="account-management-body">
      <!-- å·¦å´ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
      <nav class="account-menu">
        <ul>
          <li>
            <button class="account-menu-item" data-section="profile" onclick="switchAccountSection('profile')">
              <span class="menu-icon">ğŸ‘¤</span>
              <span class="menu-label">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</span>
            </button>
          </li>
          <li>
            <button class="account-menu-item" data-section="settings" onclick="switchAccountSection('settings')">
              <span class="menu-icon">âš™ï¸</span>
              <span class="menu-label">è¨­å®š</span>
            </button>
          </li>
          <li>
            <button class="account-menu-item active" data-section="history" onclick="switchAccountSection('history')">
              <span class="menu-icon">ğŸ“š</span>
              <span class="menu-label">å­¦ç¿’å±¥æ­´</span>
            </button>
          </li>
          <li>
            <button class="account-menu-item" data-section="achievement" onclick="switchAccountSection('achievement')">
              <span class="menu-icon">ğŸ“Š</span>
              <span class="menu-label">é”æˆåº¦</span>
            </button>
          </li>
        </ul>
      </nav>

      <!-- å³å´ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
      <div class="account-content">
        <!-- å­¦ç¿’å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="section-history" class="account-section active">
          <h3>å­¦ç¿’å±¥æ­´</h3>

          <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
          <div class="account-tabs">
            <button class="account-tab" data-level="4" onclick="switchAccountTab(4)">4ç´š</button>
            <button class="account-tab active" data-level="3" onclick="switchAccountTab(3)">3ç´š</button>
            <button class="account-tab" data-level="2" onclick="switchAccountTab(2)">2ç´š</button>
            <button class="account-tab" data-level="1" onclick="switchAccountTab(1)">1ç´š</button>
          </div>

          <!-- å±¥æ­´ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
          <div class="account-history-content">
            <div id="historyLoading" class="history-loading">
              <span>èª­ã¿è¾¼ã¿ä¸­...</span>
            </div>
            <div id="historyEmpty" class="history-empty" style="display: none;">
              <span>ã“ã®ç´šã®å­¦ç¿’å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</span>
            </div>
            <div id="historyList" class="history-list"></div>
          </div>
        </div>

        <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="section-profile" class="account-section">
          <h3>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h3>
          <div class="profile-content">
            <div class="profile-item">
              <span class="profile-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</span>
              <span class="profile-value"><%= typeof user !== 'undefined' && user ? user.username : '-' %></span>
            </div>
            <div class="profile-item">
              <span class="profile-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</span>
              <span class="profile-value"><%= typeof user !== 'undefined' && user ? user.email : '-' %></span>
            </div>
            <p class="profile-note">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ç·¨é›†æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™ã€‚</p>
          </div>
        </div>

        <!-- é”æˆåº¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="section-achievement" class="account-section">
          <h3>é”æˆåº¦</h3>

          <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
          <div class="account-tabs achievement-tabs">
            <button class="account-tab" data-level="4" onclick="switchAchievementTab(4)">4ç´š</button>
            <button class="account-tab active" data-level="3" onclick="switchAchievementTab(3)">3ç´š</button>
            <button class="account-tab" data-level="2" onclick="switchAchievementTab(2)">2ç´š</button>
            <button class="account-tab" data-level="1" onclick="switchAchievementTab(1)">1ç´š</button>
          </div>

          <!-- é”æˆåº¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
          <div class="achievement-content">
            <div id="achievementLoading" class="history-loading">
              <span>èª­ã¿è¾¼ã¿ä¸­...</span>
            </div>
            <div id="achievementEmpty" class="history-empty" style="display: none;">
              <span>ã“ã®ç´šã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“</span>
            </div>
            <div id="achievementData" class="achievement-data" style="display: none;">
              <!-- ç¶²ç¾…åº¦ãƒ¬ãƒãƒ¼ãƒˆ -->
              <div class="achievement-section coverage-section">
                <h4>ç¶²ç¾…åº¦ãƒ¬ãƒãƒ¼ãƒˆ</h4>
                <div class="coverage-bar-container">
                  <div class="coverage-bar">
                    <div id="coverageBarFill" class="coverage-bar-fill"></div>
                  </div>
                  <div class="coverage-stats">
                    <span id="coverageText">0 / 0 å•</span>
                    <span id="coveragePercent">0%</span>
                  </div>
                </div>
              </div>

              <!-- ã‚«ãƒ†ã‚´ãƒªåˆ¥æ­£è§£ç‡ -->
              <div class="achievement-section category-section">
                <h4>ã‚«ãƒ†ã‚´ãƒªåˆ¥æ­£è§£ç‡</h4>
                <div id="categoryAccuracyList" class="category-accuracy-list"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="section-settings" class="account-section">
          <h3>è¨­å®š</h3>
          <div class="settings-content">
            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ID -->
            <div class="settings-item">
              <span class="settings-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</span>
              <span class="settings-value"><%= typeof user !== 'undefined' && user ? user.user_id : '-' %></span>
            </div>

            <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ -->
            <div class="settings-item">
              <span class="settings-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</span>
              <span class="settings-value">********</span>
              <button class="btn-settings-action" onclick="openPasswordChangeModal()">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</button>
            </div>

            <!-- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ -->
            <div class="settings-item">
              <span class="settings-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</span>
              <span class="settings-value"><%= typeof user !== 'undefined' && user && user.mail ? user.mail : 'æœªç™»éŒ²' %></span>
              <button class="btn-settings-action" onclick="openEmailRegisterModal()">
                <%= typeof user !== 'undefined' && user && user.mail ? 'å¤‰æ›´' : 'ç™»éŒ²' %>
              </button>
            </div>

            <!-- ç·å­¦ç¿’å•é¡Œæ•° -->
            <div class="settings-item">
              <span class="settings-label">ç·å­¦ç¿’å•é¡Œæ•°</span>
              <span class="settings-value" id="totalLearnedCount">èª­ã¿è¾¼ã¿ä¸­...</span>
            </div>

            <!-- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ãƒœã‚¿ãƒ³ -->
            <div class="settings-danger-zone">
              <button class="btn-danger" onclick="confirmDeleteAccount()">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
let currentAccountLevel = 3;
let currentAchievementLevel = 3;
let currentSection = 'history';

function openAccountModal() {
  document.getElementById('accountModal').style.display = 'block';
  // å­¦ç¿’å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã®å ´åˆã¯å±¥æ­´ã‚’èª­ã¿è¾¼ã‚€
  if (currentSection === 'history') {
    loadAccountHistory(currentAccountLevel);
  }
}

function closeAccountModal() {
  document.getElementById('accountModal').style.display = 'none';
}

// ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆ
function switchAccountSection(section) {
  currentSection = section;

  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã® active çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
  const menuItems = document.querySelectorAll('.account-menu-item');
  menuItems.forEach(item => {
    item.classList.remove('active');
    if (item.dataset.section === section) {
      item.classList.add('active');
    }
  });

  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
  const sections = document.querySelectorAll('.account-section');
  sections.forEach(sec => {
    sec.classList.remove('active');
  });
  document.getElementById('section-' + section).classList.add('active');

  // å­¦ç¿’å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å ´åˆã¯å±¥æ­´ã‚’èª­ã¿è¾¼ã‚€
  if (section === 'history') {
    loadAccountHistory(currentAccountLevel);
  }

  // è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å ´åˆã¯ç·å­¦ç¿’å•é¡Œæ•°ã‚’èª­ã¿è¾¼ã‚€
  if (section === 'settings') {
    loadTotalLearnedCount();
  }

  // é”æˆåº¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å ´åˆã¯é”æˆåº¦ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
  if (section === 'achievement') {
    loadAchievementData(currentAchievementLevel);
  }
}

function switchAccountTab(level) {
  currentAccountLevel = level;

  // ã‚¿ãƒ–ã® active çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
  const tabs = document.querySelectorAll('.account-tab');
  tabs.forEach(tab => {
    tab.classList.remove('active');
    if (parseInt(tab.dataset.level) === level) {
      tab.classList.add('active');
    }
  });

  loadAccountHistory(level);
}

async function loadAccountHistory(testlevel) {
  const loadingEl = document.getElementById('historyLoading');
  const emptyEl = document.getElementById('historyEmpty');
  const listEl = document.getElementById('historyList');

  loadingEl.style.display = 'block';
  emptyEl.style.display = 'none';
  listEl.innerHTML = '';

  try {
    const response = await fetch(`/account/history/${testlevel}`);
    const data = await response.json();

    loadingEl.style.display = 'none';

    if (!data.history || data.history.length === 0) {
      emptyEl.style.display = 'block';
      return;
    }

    // å±¥æ­´ã‚’è¡¨ç¤ºï¼ˆblank_idæ¯ã«1è¡Œï¼‰
    data.history.forEach(item => {
      const questionRow = document.createElement('div');
      questionRow.className = 'history-question-row';

      // question_id + blankç•ªå·ã§1è¡Œè¡¨ç¤º
      let rowContent = `<a href="/account/view/${item.question_id}" class="history-question-link">${item.question_id} (${item.blank_number})</a>`;
      rowContent += '<span class="history-separator">ï½œ</span>';

      // ç›´è¿‘3å›ã®çµæœã‚’è¡¨ç¤º
      const marks = item.attempts.map(a =>
        a.is_correct ? '<span class="mark-correct">ã€‡</span>' : '<span class="mark-incorrect">Ã—</span>'
      ).join(' ');

      rowContent += `<span class="history-results">${marks}</span>`;

      questionRow.innerHTML = rowContent;
      listEl.appendChild(questionRow);
    });

  } catch (err) {
    console.error('å±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
    loadingEl.style.display = 'none';
    emptyEl.textContent = 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
    emptyEl.style.display = 'block';
  }
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹
window.addEventListener('click', function(event) {
  const modal = document.getElementById('accountModal');
  if (event.target === modal) {
    closeAccountModal();
  }
});

// ç·å­¦ç¿’å•é¡Œæ•°ã‚’å–å¾—
async function loadTotalLearnedCount() {
  const countEl = document.getElementById('totalLearnedCount');
  if (!countEl) return;

  countEl.textContent = 'èª­ã¿è¾¼ã¿ä¸­...';

  try {
    const response = await fetch('/account/stats/total-learned');
    const data = await response.json();

    if (data.count !== undefined) {
      countEl.textContent = data.count + ' å•';
    } else {
      countEl.textContent = 'å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
    }
  } catch (err) {
    console.error('ç·å­¦ç¿’å•é¡Œæ•°å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
    countEl.textContent = 'å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
  }
}

// é”æˆåº¦ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
function switchAchievementTab(level) {
  currentAchievementLevel = level;

  // ã‚¿ãƒ–ã® active çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆï¼ˆé”æˆåº¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã®ã¿ï¼‰
  const tabs = document.querySelectorAll('.achievement-tabs .account-tab');
  tabs.forEach(tab => {
    tab.classList.remove('active');
    if (parseInt(tab.dataset.level) === level) {
      tab.classList.add('active');
    }
  });

  loadAchievementData(level);
}

// é”æˆåº¦ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
async function loadAchievementData(testlevel) {
  const loadingEl = document.getElementById('achievementLoading');
  const emptyEl = document.getElementById('achievementEmpty');
  const dataEl = document.getElementById('achievementData');

  loadingEl.style.display = 'flex';
  emptyEl.style.display = 'none';
  dataEl.style.display = 'none';

  try {
    const response = await fetch(`/account/achievement/${testlevel}`);
    const data = await response.json();

    loadingEl.style.display = 'none';

    // ç¶²ç¾…åº¦ãŒ0ã®å ´åˆï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰
    if (data.coverage.total === 0) {
      emptyEl.style.display = 'flex';
      return;
    }

    dataEl.style.display = 'block';

    // ç¶²ç¾…åº¦ãƒ¬ãƒãƒ¼ãƒˆã‚’æ›´æ–°
    const coveragePercent = data.coverage.total > 0
      ? Math.round((data.coverage.answered / data.coverage.total) * 100)
      : 0;
    document.getElementById('coverageBarFill').style.width = coveragePercent + '%';
    document.getElementById('coverageText').textContent = `${data.coverage.answered} / ${data.coverage.total} å•`;
    document.getElementById('coveragePercent').textContent = coveragePercent + '%';

    // ã‚«ãƒ†ã‚´ãƒªåˆ¥æ­£è§£ç‡ã‚’æ›´æ–°
    const categoryListEl = document.getElementById('categoryAccuracyList');
    categoryListEl.innerHTML = '';

    // å›ç­”ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
    if (Object.keys(data.categories).length === 0) {
      categoryListEl.innerHTML = '<p class="no-data-message">ã¾ã å›ç­”ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
      return;
    }

    // large_categoryæ¯ã«è¡¨ç¤º
    Object.entries(data.categories).forEach(([largeCategoryName, smallCategories]) => {
      const largeCategoryDiv = document.createElement('div');
      largeCategoryDiv.className = 'large-category-block';

      const header = document.createElement('div');
      header.className = 'large-category-header';
      header.textContent = largeCategoryName;
      largeCategoryDiv.appendChild(header);

      const smallList = document.createElement('div');
      smallList.className = 'small-category-list';

      smallCategories.forEach(small => {
        const smallItem = document.createElement('div');
        smallItem.className = 'small-category-item';

        const barColor = getAccuracyColor(small.accuracy);

        smallItem.innerHTML = `
          <div class="small-category-name">${small.small_category_name}</div>
          <div class="accuracy-bar-container">
            <div class="accuracy-bar">
              <div class="accuracy-bar-fill" style="width: ${small.accuracy}%; background-color: ${barColor};"></div>
            </div>
            <span class="accuracy-percent">${small.accuracy}%</span>
          </div>
        `;

        smallList.appendChild(smallItem);
      });

      largeCategoryDiv.appendChild(smallList);
      categoryListEl.appendChild(largeCategoryDiv);
    });

  } catch (err) {
    console.error('é”æˆåº¦ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
    loadingEl.style.display = 'none';
    emptyEl.textContent = 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
    emptyEl.style.display = 'flex';
  }
}

// æ­£è§£ç‡ã«å¿œã˜ãŸè‰²ã‚’è¿”ã™
function getAccuracyColor(accuracy) {
  if (accuracy >= 80) return '#28a745'; // ç·‘
  if (accuracy >= 60) return '#8b6ccf'; // ç´«
  if (accuracy >= 40) return '#ffc107'; // é»„è‰²
  return '#dc3545'; // èµ¤
}

// ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
function openPasswordChangeModal() {
  alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™ã€‚');
}

// ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
function openEmailRegisterModal() {
  alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç™»éŒ²æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™ã€‚');
}

// ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ç¢ºèª
function confirmDeleteAccount() {
  if (confirm('æœ¬å½“ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
    deleteAccount();
  }
}

// ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤å®Ÿè¡Œ
async function deleteAccount() {
  try {
    const response = await fetch('/account/delete', {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    const data = await response.json();

    if (data.success) {
      alert('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚');
      window.location.href = '/';
    } else {
      alert('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    }
  } catch (err) {
    console.error('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', err);
    alert('ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
  }
}
</script>
