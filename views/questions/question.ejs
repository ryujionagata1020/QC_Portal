<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <%- include("../_share/metadata.ejs") %>
  <title>ÂïèÈ°å <%= question_id %></title>
  <!-- Â§ñÈÉ®CSS„Çí‰Ωø„ÅÜÂ†¥Âêà -->
  <link rel="stylesheet" href="https://unpkg.com/ress/dist/ress.min.css" />
  <!-- Ëá™ÂâçCSSË®≠ÂÆö -->
  <link rel="stylesheet" href="/public/index.css">
  <!-- KaTeX CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">
</head>

<body>
  <%- include("../_share/navbar.ejs") %>

  <main class="question-container">
    <% if (typeof currentNumber !== 'undefined' && typeof totalCount !== 'undefined') { %>
      <div class="question-progress-container">
        <div class="question-progress"><%= currentNumber %>ÂïèÁõÆ / <%= totalCount %>Âïè‰∏≠</div>
      </div>
    <% } %>
    <div class="question-header">
      <h2>ÂïèÈ°åIDÔºö<%= question_id %></h2>
    </div>
    <div class="meta">
      <div>„Ç´„ÉÜ„Ç¥„É™Ôºö<%= large_category_name %> Ôºû <%= small_category_name %></div>
      <div>Èõ£ÊòìÂ∫¶Ôºö<%= testlevel %>Á¥ö</div>
    </div>

    <% if (image_data) { %>
      <div class="img-area">
        <img src="data:<%= image_mime_type %>;base64,<%= image_data %>" alt="ÂïèÈ°åÂõ≥">
      </div>
    <% } %>

    <div class="body">
      <p class="latex-content"><%= body %></p>
    </div>

    <div class="blanks-area">
      <% if (blanks.length > 1) { %>
        <!-- „Éñ„É©„É≥„ÇØ„ÅåË§áÊï∞„ÅÆÂ†¥ÂêàÔºö„Çø„ÉñÂàá„ÇäÊõø„Åà -->
        <div class="blank-tab-bar">
          <% blanks.forEach(function(blank, i) { %>
            <button class="blank-tab-btn<%= i === 0 ? ' active' : '' %>"
                    data-blank-id="<%= blank.blank_id %>"
                    onclick="switchBlankTab('<%= blank.blank_id %>', this)">
              Ôºà<%= blank.blank_number %>Ôºâ
            </button>
          <% }); %>
        </div>
        <% blanks.forEach(function(blank, i) { %>
          <div class="blank-panel" id="panel_<%= blank.blank_id %>"<%= i !== 0 ? ' style="display:none"' : '' %>>
            <div class="blank-block">
              <div class="blank-header">
                <span id="result_<%= blank.blank_id %>" class="resultArea"></span>
              </div>
              <div class="choice-grid" id="choices_<%= blank.blank_id %>">
                <% (blank.choices || []).forEach(function(choice) { %>
                  <div class="choice-cell">
                    <button class="choice-btn"
                            id="btn_<%= blank.blank_id %>_<%= choice.choice_id %>"
                            onclick="checkAnswer('<%= blank.blank_id %>', '<%= choice.choice_id %>')">
                      <%= choice.label %>
                    </button>
                    <span class="latex-content" data-latex="true"><%= choice.text %></span>
                  </div>
                <% }); %>
              </div>
              <% if (blank.explanation) { %>
                <button class="btn toggle-explanation-btn" data-blank="<%= blank.blank_id %>">Ëß£Ë™¨„Çí„Åø„Çã</button>
                <div id="explanation_<%= blank.blank_id %>" class="blank-explanation" style="display:none;">
                  <div class="latex-content"><%= blank.explanation %></div>
                  <% if (blank.explanation_data) { %>
                    <div class="explanation-img-area">
                      <img src="data:<%= blank.explanation_mime_type %>;base64,<%= blank.explanation_data %>" alt="Ëß£Ë™¨Âõ≥Ôºà<%= blank.blank_number %>Ôºâ">
                    </div>
                  <% } %>
                </div>
              <% } %>
            </div>
          </div>
        <% }); %>
      <% } else { %>
        <!-- „Éñ„É©„É≥„ÇØ„Åå1„Å§„ÅÆÂ†¥ÂêàÔºö„Çø„Éñ„Å™„ÅóÔºàÂæìÊù•„É¨„Ç§„Ç¢„Ç¶„ÉàÔºâ -->
        <% blanks.forEach(function(blank) { %>
          <div class="blank-block">
            <div class="blank-header">
              <h3>Ôºà<%= blank.blank_number %>Ôºâ</h3>
              <span id="result_<%= blank.blank_id %>" class="resultArea"></span>
            </div>
            <div class="choice-grid" id="choices_<%= blank.blank_id %>">
              <% (blank.choices || []).forEach(function(choice) { %>
                <div class="choice-cell">
                  <button class="choice-btn"
                          id="btn_<%= blank.blank_id %>_<%= choice.choice_id %>"
                          onclick="checkAnswer('<%= blank.blank_id %>', '<%= choice.choice_id %>')">
                    <%= choice.label %>
                  </button>
                  <span class="latex-content" data-latex="true"><%= choice.text %></span>
                </div>
              <% }); %>
            </div>
            <% if (blank.explanation) { %>
              <button class="btn toggle-explanation-btn" data-blank="<%= blank.blank_id %>">Ëß£Ë™¨„Çí„Åø„Çã</button>
              <div id="explanation_<%= blank.blank_id %>" class="blank-explanation" style="display:none;">
                <div class="latex-content"><%= blank.explanation %></div>
                <% if (blank.explanation_data) { %>
                  <div class="explanation-img-area">
                    <img src="data:<%= blank.explanation_mime_type %>;base64,<%= blank.explanation_data %>" alt="Ëß£Ë™¨Âõ≥Ôºà<%= blank.blank_number %>Ôºâ">
                  </div>
                <% } %>
              </div>
            <% } %>
          </div>
        <% }); %>
      <% } %>
    </div>

    <% if (typeof isAuthenticated !== 'undefined' && isAuthenticated) { %>
    <div class="qcheck-container">
      <label class="qcheck-label qcheck-yellow">
        <input type="checkbox" class="qcheck-input" data-color="yellow"
          <%= (typeof checkedColors !== 'undefined' && checkedColors.includes('yellow')) ? 'checked' : '' %>
          onchange="toggleQuestionCheck('<%= question_id %>', 'yellow', this.checked)">
        <span class="qcheck-box"></span>
      </label>
      <label class="qcheck-label qcheck-green">
        <input type="checkbox" class="qcheck-input" data-color="green"
          <%= (typeof checkedColors !== 'undefined' && checkedColors.includes('green')) ? 'checked' : '' %>
          onchange="toggleQuestionCheck('<%= question_id %>', 'green', this.checked)">
        <span class="qcheck-box"></span>
      </label>
      <label class="qcheck-label qcheck-red">
        <input type="checkbox" class="qcheck-input" data-color="red"
          <%= (typeof checkedColors !== 'undefined' && checkedColors.includes('red')) ? 'checked' : '' %>
          onchange="toggleQuestionCheck('<%= question_id %>', 'red', this.checked)">
        <span class="qcheck-box"></span>
      </label>
    </div>
    <% } %>

    <div class="next-button-container">
      <% if (nextId) { %>
        <button type="button" class="btn-next" onclick="goNextQuestion()">Ê¨°„ÅÆÂïèÈ°å„Å∏</button>
      <% } else { %>
        <button type="button" class="btn-next" onclick="showCompletionOverlay()">„Åì„Çå„ÅßÁµÇ‰∫Ü„Åß„Åô</button>
      <% } %>
    </div>

    <!-- ‚úÖ „Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div id="overlay" class="overlay">
      <div class="overlay-content" id="overlayMessage"></div>
    </div>

    <!-- ÁµÇ‰∫ÜÊôÇ„Ç™„Éº„Éê„Éº„É¨„Ç§ -->
    <div id="completionOverlay" class="completion-overlay">
      <div class="completion-content">
        <div class="completion-icon">üéâ</div>
        <div class="completion-message" id="completionMessage"></div>
        <div id="completionAchievement" class="completion-achievement"></div>
        <button class="btn-completion-close" onclick="closeCompletionOverlay()">Èñâ„Åò„Çã</button>
      </div>
    </div>
  </main>

  <%- include("../_share/footer.ejs") %>

  <!-- KaTeX JS -->
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>
  <script>
    // ==== KaTeXËá™Âãï„É¨„É≥„ÉÄ„É™„É≥„Ç∞ ====
    function renderAllLatex() {
      console.log('renderAllLatex called');
      console.log('renderMathInElement:', typeof renderMathInElement);
      document.querySelectorAll('.latex-content').forEach(function(elem) {
        console.log('Processing element:', elem.textContent);
        renderMathInElement(elem, {
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
            {left: '\\[', right: '\\]', display: true},
            {left: '\\(', right: '\\)', display: false}
          ],
          throwOnError: false
        });
      });
    }
    // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„Å´„É¨„É≥„ÉÄ„É™„É≥„Ç∞ÂÆüË°å
    renderAllLatex();

    // ==== Ëß£Ë™¨„ÅÆÈñãÈñâÔºàblank_id„Åî„Å®Ôºâ ====
    document.querySelectorAll('.toggle-explanation-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const blankId = btn.dataset.blank;
        const exp = document.getElementById('explanation_' + blankId);
        if (!exp) return;
        const show = exp.style.display === 'none';
        exp.style.display = show ? 'block' : 'none';
        btn.textContent = show ? 'Ëß£Ë™¨„ÇíÈö†„Åô' : 'Ëß£Ë™¨„Çí„Åø„Çã';
        // ÂàùÂõûË°®Á§∫ÊôÇ„Å´KaTeX„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
        if (show && !exp.dataset.rendered) {
          exp.querySelectorAll('.latex-content').forEach(function(elem) {
            renderMathInElement(elem, {
              delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\[', right: '\\]', display: true},
                {left: '\\(', right: '\\)', display: false}
              ],
              throwOnError: false
            });
          });
          exp.dataset.rendered = '1';
        }
      });
    });

    // ==== ÂïèÈ°å„ÉÅ„Çß„ÉÉ„ÇØÔºàÈªÑ„ÉªÁ∑ë„ÉªËµ§Ôºâ ====
    async function toggleQuestionCheck(questionId, color, isChecked) {
      try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
        await fetch('/questions/' + questionId + '/check', {
          method: isChecked ? 'POST' : 'DELETE',
          headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
          body: JSON.stringify({ color: color })
        });
      } catch (err) {
        console.error('„ÉÅ„Çß„ÉÉ„ÇØÊõ¥Êñ∞Â§±Êïó:', err);
      }
    }

    // ==== ÂõûÁ≠î„ÉÅ„Çß„ÉÉ„ÇØ ====
    async function checkAnswer(blankId, selectedChoiceId) {
      try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
        const response = await fetch("/questions/answer", {
          method: "POST",
          headers: { "Content-Type": "application/json", "X-CSRF-Token": csrfToken },
          body: JSON.stringify({
            blank_id: blankId,
            choice_id: selectedChoiceId
          })
        });
        const result = await response.json();

        const choiceButtons = document.querySelectorAll(`#choices_${blankId} .choice-btn`);
        choiceButtons.forEach(btn => {
          btn.style.backgroundColor = "";
          btn.style.borderColor = "#888";
        });

        const selectedBtn = document.getElementById(`btn_${blankId}_${selectedChoiceId}`);
        if (result.isCorrect) {
          selectedBtn.style.backgroundColor = "#c8facc";
          selectedBtn.style.borderColor = "green";
        } else {
          selectedBtn.style.backgroundColor = "#fdd";
          selectedBtn.style.borderColor = "red";

          // ‚úÖ ‰∏çÊ≠£Ëß£ÊôÇ„ÅØËß£Ë™¨„ÇíËá™ÂãïÂ±ïÈñã
          autoExpandExplanation(blankId);
        }

        const resultArea = document.getElementById(`result_${blankId}`);
        resultArea.innerHTML = result.isCorrect
          ? "<span style='color: green; font-weight:bold;'>„Äá Ê≠£Ëß£</span>"
          : "<span style='color: red; font-weight:bold;'>√ó ‰∏çÊ≠£Ëß£</span>";
        resultArea.style.display = "block";

        // ‚úÖ „Ç™„Éº„Éê„Éº„É¨„Ç§„ÇíË°®Á§∫
        showOverlay(result.isCorrect);

      } catch (err) {
        console.error("Á≠î„Åà„ÉÅ„Çß„ÉÉ„ÇØÂ§±Êïó:", err);
      }
    }

    // ==== „Çø„ÉñÂàá„ÇäÊõø„Åà ====
    function switchBlankTab(blankId, btnEl) {
      document.querySelectorAll('.blank-panel').forEach(panel => panel.style.display = 'none');
      document.querySelectorAll('.blank-tab-btn').forEach(btn => btn.classList.remove('active'));
      const panel = document.getElementById('panel_' + blankId);
      if (panel) panel.style.display = 'block';
      btnEl.classList.add('active');
    }

    // ==== ‰∏çÊ≠£Ëß£ÊôÇ„Å´Ëß£Ë™¨„ÇíËá™ÂãïÂ±ïÈñã„Åô„ÇãÈñ¢Êï∞ ====
    function autoExpandExplanation(blankId) {
      // SECURITY: blankId„Çí„Çµ„Éã„Çø„Ç§„Ç∫„Åó„Å¶CSS selector injection „ÇíÈò≤Ê≠¢
      // ID„ÅØËã±Êï∞Â≠ó„ÄÅ„Éè„Ç§„Éï„É≥„ÄÅ„Ç¢„É≥„ÉÄ„Éº„Çπ„Ç≥„Ç¢„ÅÆ„ÅøË®±ÂèØ
      const sanitizedBlankId = String(blankId).replace(/[^A-Za-z0-9\-_]/g, '');

      if (!sanitizedBlankId) {
        console.error('Invalid blank_id:', blankId);
        return;
      }

      // „Çµ„Éã„Çø„Ç§„Ç∫„Åï„Çå„ÅüID„Çí‰ΩøÁî®„Åó„Å¶DOMË¶ÅÁ¥†„ÇíÂèñÂæó
      const exp = document.getElementById('explanation_' + sanitizedBlankId);
      const btn = document.querySelector(`.toggle-explanation-btn[data-blank="${sanitizedBlankId}"]`);

      // Êó¢„Å´Â±ïÈñã„Åï„Çå„Å¶„ÅÑ„ÇãËß£Ë™¨„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºàÂêå‰∏Ä„Éë„Éç„É´ÂÜÖ„ÅÆ„ÅøÔºâ
      const scope = (exp && exp.closest('.blank-panel')) || document.querySelector('.blanks-area');
      const alreadyExpanded = scope
        ? Array.from(scope.querySelectorAll('.blank-explanation')).some(e => e.style.display === 'block')
        : false;

      if (alreadyExpanded) return;

      if (!exp || !btn) {
        console.warn('Explanation or button not found for blank_id:', sanitizedBlankId);
        return;
      }

      // Ëß£Ë™¨„ÇíÂ±ïÈñã
      exp.style.display = 'block';
      btn.textContent = 'Ëß£Ë™¨„ÇíÈö†„Åô';

      // ÂàùÂõûË°®Á§∫ÊôÇ„Å´KaTeX„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
      if (!exp.dataset.rendered) {
        exp.querySelectorAll('.latex-content').forEach(function(elem) {
          renderMathInElement(elem, {
            delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\[', right: '\\]', display: true},
              {left: '\\(', right: '\\)', display: false}
            ],
            throwOnError: false
          });
        });
        exp.dataset.rendered = '1';
      }

      // Ëß£Ë™¨„Ç®„É™„Ç¢„Åæ„Åß„Çπ„ÇØ„É≠„Éº„É´„Åó„Å¶„Éï„Ç©„Éº„Ç´„Çπ„ÇíË®≠ÂÆö
      setTimeout(() => {
        exp.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        exp.setAttribute('tabindex', '-1');
        exp.focus();
      }, 100);
    }

    // ==== „Ç™„Éº„Éê„Éº„É¨„Ç§„ÇíË°®Á§∫„Åô„ÇãÈñ¢Êï∞ ====
    function showOverlay(isCorrect) {
      const overlay = document.getElementById("overlay");
      overlay.className = "overlay " + (isCorrect ? "correct" : "incorrect");
      overlay.style.display = "flex";

      setTimeout(() => {
        overlay.style.display = "none";
      }, 1800);
    }

    // ==== Ê¨°„ÅÆÂïèÈ°å ====
    function goNextQuestion() {
      const next = "<%= nextId %>";
      if (next) window.location.href = "/questions/" + next;
    }

    // ==== ÁµÇ‰∫ÜÊôÇ„Ç™„Éº„Éê„Éº„É¨„Ç§„ÇíË°®Á§∫„Åô„ÇãÈñ¢Êï∞ ====
    async function showCompletionOverlay() {
      const messages = [
        "„Åå„Çì„Å∞„Çä„Åæ„Åó„ÅüÔºÅ",
        "„Åä„Å§„Åã„Çå„Åï„ÅæÔºÅ",
        "„Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ",
        "„Åô„Å∞„Çâ„Åó„ÅÑÔºÅ",
        "ÂÆåËµ∞„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ"
      ];
      const randomMessage = messages[Math.floor(Math.random() * messages.length)];

      document.getElementById("completionMessage").textContent = randomMessage;
      document.getElementById("completionOverlay").style.display = "flex";

      // ÈÅîÊàêÂ∫¶„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„Å¶Ë°®Á§∫
      try {
        const res = await fetch("/questions/completion-stats");
        const data = await res.json();
        if (data.categories && data.categories.length > 0) {
          renderAchievementBars(data.categories);
        }
      } catch (e) {
        console.error("ÈÅîÊàêÂ∫¶„Éá„Éº„ÇøÂèñÂæóÂ§±Êïó:", e);
      }
    }

    // ==== ÈÅîÊàêÂ∫¶„Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„ÇíÊèèÁîª„Åô„ÇãÈñ¢Êï∞ ====
    function renderAchievementBars(categories) {
      const container = document.getElementById("completionAchievement");

      // Â§ß„Ç´„ÉÜ„Ç¥„É™„Åß„Ç∞„É´„Éº„ÉóÂåñ
      const grouped = {};
      categories.forEach(cat => {
        if (!grouped[cat.large_category_name]) {
          grouped[cat.large_category_name] = [];
        }
        grouped[cat.large_category_name].push(cat);
      });

      let html = '<div class="completion-achievement-title">„Ç´„ÉÜ„Ç¥„É™Âà• ÈÅîÊàêÂ∫¶</div>';
      let barIndex = 0;

      Object.entries(grouped).forEach(([largeName, smalls]) => {
        html += '<div class="completion-large-category">';
        html += '<div class="completion-large-header">' + escapeHtml(largeName) + '</div>';
        html += '<div class="completion-small-list">';

        smalls.forEach(cat => {
          const barId = 'cbar-' + barIndex;
          const diff = cat.after_accuracy - cat.before_accuracy;
          const diffText = cat.before_total > 0 && diff !== 0
            ? (diff > 0 ? '+' + diff : String(diff))
            : '';

          html += '<div class="completion-small-item">';
          html += '  <div class="completion-cat-name">' + escapeHtml(cat.small_category_name) + '</div>';
          html += '  <div class="completion-bar-wrapper">';
          html += '    <div class="completion-bar-track">';
          // before„Éê„ÉºÔºàÊ∑°„ÅÑËâ≤„ÄÅ‰∏ãÂ±§Ôºâ
          html += '      <div class="completion-bar-before" id="' + barId + '-before" style="width:0%"></div>';
          // after„Éê„ÉºÔºà„É°„Ç§„É≥Ëâ≤„ÄÅ‰∏äÂ±§Ôºâ
          html += '      <div class="completion-bar-after" id="' + barId + '-after" style="width:0%"></div>';
          html += '    </div>';
          html += '    <div class="completion-bar-labels">';
          html += '      <span class="completion-bar-percent" id="' + barId + '-pct">0%</span>';
          if (diffText) {
            const diffClass = diff > 0 ? 'positive' : 'negative';
            html += '      <span class="completion-bar-diff ' + diffClass + '" id="' + barId + '-diff" style="opacity:0">' + diffText + '</span>';
          }
          html += '    </div>';
          html += '  </div>';
          html += '</div>';
          barIndex++;
        });

        html += '</div></div>';
      });

      // Âá°‰æã
      html += '<div class="completion-legend">';
      html += '  <span class="completion-legend-item"><span class="completion-legend-color before"></span>Ëß£„ÅèÂâç</span>';
      html += '  <span class="completion-legend-item"><span class="completion-legend-color after"></span>Ëß£„ÅÑ„ÅüÂæå</span>';
      html += '</div>';

      container.innerHTML = html;

      // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆüË°å
      let idx = 0;
      Object.values(grouped).forEach(smalls => {
        smalls.forEach(cat => {
          const barId = 'cbar-' + idx;
          animateBar(barId, cat, idx);
          idx++;
        });
      });
    }

    // ==== ÂÄãÂà•„Éê„Éº„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ ====
    function animateBar(barId, cat, index) {
      const beforeEl = document.getElementById(barId + '-before');
      const afterEl = document.getElementById(barId + '-after');
      const pctEl = document.getElementById(barId + '-pct');
      const diffEl = document.getElementById(barId + '-diff');
      if (!beforeEl || !afterEl) return;

      const stagger = index * 200;

      // Step1: before„Éê„Éº„ÇíË°®Á§∫Ôºà0.4sÂæåÔºâ
      setTimeout(() => {
        beforeEl.style.width = cat.before_accuracy + '%';
        if (pctEl) animateCounter(pctEl, 0, cat.before_accuracy, 400);
      }, 400 + stagger);

      // Step2: after„Éê„Éº„ÇíË°®Á§∫Ôºà1.0sÂæåÔºâ
      setTimeout(() => {
        afterEl.style.width = cat.after_accuracy + '%';
        if (pctEl) animateCounter(pctEl, cat.before_accuracy, cat.after_accuracy, 500);
        // Â∑ÆÂàÜ„É©„Éô„É´„Çí„Éï„Çß„Éº„Éâ„Ç§„É≥
        if (diffEl) {
          setTimeout(() => { diffEl.style.opacity = '1'; }, 500);
        }
      }, 1000 + stagger);
    }

    // ==== Êï∞ÂÄ§„Ç´„Ç¶„É≥„Çø„Éº„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ ====
    function animateCounter(el, from, to, duration) {
      const start = performance.now();
      function update(now) {
        const elapsed = now - start;
        const progress = Math.min(elapsed / duration, 1);
        const value = Math.round(from + (to - from) * progress);
        el.textContent = value + '%';
        if (progress < 1) requestAnimationFrame(update);
      }
      requestAnimationFrame(update);
    }

    // HTML„Ç®„Çπ„Ç±„Éº„Éó
    function escapeHtml(str) {
      const div = document.createElement('div');
      div.appendChild(document.createTextNode(str));
      return div.innerHTML;
    }

    // ==== ÁµÇ‰∫Ü„Ç™„Éº„Éê„Éº„É¨„Ç§„ÇíÈñâ„Åò„ÇãÈñ¢Êï∞ ====
    function closeCompletionOverlay() {
      document.getElementById("completionOverlay").style.display = "none";
      // Âá∫È°å„Çª„ÉÉ„Ç∑„Éß„É≥„Çí„ÇØ„É™„Ç¢„Åó„Å¶„Åã„ÇâÈÅ∏ÊäûÁîªÈù¢„Å∏Êàª„Çã
      const csrfToken2 = document.querySelector('meta[name="csrf-token"]').content;
      fetch("/questions/complete", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRF-Token": csrfToken2 }
      })
        .then(() => {
          window.location.href = "/questions/select";
        })
        .catch(() => {
          window.location.href = "/questions/select";
        });
    }

  </script>
</body>
</html>