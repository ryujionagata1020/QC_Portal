<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <%- include("../_share/metadata.ejs") %>
  <title>å•é¡Œ <%= question_id %></title>
  <!-- å¤–éƒ¨CSSã‚’ä½¿ã†å ´åˆ -->
  <link rel="stylesheet" href="https://unpkg.com/ress/dist/ress.min.css" />
  <!-- è‡ªå‰CSSè¨­å®š -->
  <link rel="stylesheet" href="/public/index.css">
  <!-- KaTeX CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">
</head>

<body>
  <%- include("../_share/navbar.ejs") %>

  <main class="question-container">
    <% if (typeof currentNumber !== 'undefined' && typeof totalCount !== 'undefined') { %>
      <div class="question-progress-container">
        <div class="question-progress"><%= currentNumber %>å•ç›® / <%= totalCount %>å•ä¸­</div>
      </div>
    <% } %>
    <div class="question-header">
      <h2>å•é¡ŒIDï¼š<%= question_id %></h2>
    </div>
    <div class="meta">
      <div>ã‚«ãƒ†ã‚´ãƒªï¼š<%= large_category_name %> ï¼ <%= small_category_name %></div>
      <div>é›£æ˜“åº¦ï¼š<%= testlevel %>ç´š</div>
    </div>

    <% if (image_data) { %>
      <div class="img-area">
        <img src="data:<%= image_mime_type %>;base64,<%= image_data %>" alt="å•é¡Œå›³" width="400">
      </div>
    <% } %>

    <div class="body">
      <p class="latex-content"><%= body %></p>
    </div>

    <div class="blanks-area">
      <% blanks.forEach(function(blank) { %>
        <div class="blank-block">
          <div class="blank-header">
            <h3>ï¼ˆ<%= blank.blank_number %>ï¼‰</h3>
            <span id="result_<%= blank.blank_id %>" class="resultArea"></span>
          </div>
          <div class="choice-grid" id="choices_<%= blank.blank_id %>">
            <% (blank.choices || []).forEach(function(choice) { %>
              <div class="choice-cell">
                <button class="choice-btn"
                        id="btn_<%= blank.blank_id %>_<%= choice.choice_id %>"
                        onclick="checkAnswer('<%= blank.blank_id %>', '<%= choice.choice_id %>')">
                  <%= choice.label %>
                </button>
                <span class="latex-content" data-latex="true"><%= choice.text %></span>
              </div>
            <% }); %>
          </div>
          <% if (blank.explanation) { %>
            <button class="btn toggle-explanation-btn" data-blank="<%= blank.blank_id %>">è§£èª¬ã‚’ã¿ã‚‹</button>
            <div id="explanation_<%= blank.blank_id %>" class="blank-explanation" style="display:none;">
              <div class="latex-content"><%= blank.explanation %></div>
              <% if (blank.explanation_data) { %>
                <div class="explanation-img-area">
                  <img src="data:<%= blank.explanation_mime_type %>;base64,<%= blank.explanation_data %>" alt="è§£èª¬å›³ï¼ˆ<%= blank.blank_number %>ï¼‰" width="400">
                </div>
              <% } %>
            </div>
          <% } %>
        </div>
      <% }); %>
    </div>

    <% if (typeof isAuthenticated !== 'undefined' && isAuthenticated) { %>
    <div class="qcheck-container">
      <label class="qcheck-label qcheck-yellow">
        <input type="checkbox" class="qcheck-input" data-color="yellow"
          <%= (typeof checkedColors !== 'undefined' && checkedColors.includes('yellow')) ? 'checked' : '' %>
          onchange="toggleQuestionCheck('<%= question_id %>', 'yellow', this.checked)">
        <span class="qcheck-box"></span>
      </label>
      <label class="qcheck-label qcheck-green">
        <input type="checkbox" class="qcheck-input" data-color="green"
          <%= (typeof checkedColors !== 'undefined' && checkedColors.includes('green')) ? 'checked' : '' %>
          onchange="toggleQuestionCheck('<%= question_id %>', 'green', this.checked)">
        <span class="qcheck-box"></span>
      </label>
      <label class="qcheck-label qcheck-red">
        <input type="checkbox" class="qcheck-input" data-color="red"
          <%= (typeof checkedColors !== 'undefined' && checkedColors.includes('red')) ? 'checked' : '' %>
          onchange="toggleQuestionCheck('<%= question_id %>', 'red', this.checked)">
        <span class="qcheck-box"></span>
      </label>
    </div>
    <% } %>

    <div class="next-button-container">
      <% if (nextId) { %>
        <button type="button" class="btn-next" onclick="goNextQuestion()">æ¬¡ã®å•é¡Œã¸</button>
      <% } else { %>
        <button type="button" class="btn-next" onclick="showCompletionOverlay()">ã“ã‚Œã§çµ‚äº†ã§ã™</button>
      <% } %>
    </div>

    <!-- âœ… ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="overlay" class="overlay">
      <div class="overlay-content" id="overlayMessage"></div>
    </div>

    <!-- çµ‚äº†æ™‚ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="completionOverlay" class="completion-overlay">
      <div class="completion-content">
        <div class="completion-icon">ğŸ‰</div>
        <div class="completion-message" id="completionMessage"></div>
        <div id="completionAchievement" class="completion-achievement"></div>
        <button class="btn-completion-close" onclick="closeCompletionOverlay()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </main>

  <%- include("../_share/footer.ejs") %>

  <!-- KaTeX JS -->
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>
  <script>
    // ==== KaTeXè‡ªå‹•ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ====
    function renderAllLatex() {
      console.log('renderAllLatex called');
      console.log('renderMathInElement:', typeof renderMathInElement);
      document.querySelectorAll('.latex-content').forEach(function(elem) {
        console.log('Processing element:', elem.textContent);
        renderMathInElement(elem, {
          delimiters: [
            {left: '$$', right: '$$', display: true},
            {left: '$', right: '$', display: false},
            {left: '\\[', right: '\\]', display: true},
            {left: '\\(', right: '\\)', display: false}
          ],
          throwOnError: false
        });
      });
    }
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Ÿè¡Œ
    renderAllLatex();

    // ==== è§£èª¬ã®é–‹é–‰ï¼ˆblank_idã”ã¨ï¼‰ ====
    document.querySelectorAll('.toggle-explanation-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const blankId = btn.dataset.blank;
        const exp = document.getElementById('explanation_' + blankId);
        if (!exp) return;
        const show = exp.style.display === 'none';
        exp.style.display = show ? 'block' : 'none';
        btn.textContent = show ? 'è§£èª¬ã‚’éš ã™' : 'è§£èª¬ã‚’ã¿ã‚‹';
        // åˆå›è¡¨ç¤ºæ™‚ã«KaTeXã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        if (show && !exp.dataset.rendered) {
          exp.querySelectorAll('.latex-content').forEach(function(elem) {
            renderMathInElement(elem, {
              delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\[', right: '\\]', display: true},
                {left: '\\(', right: '\\)', display: false}
              ],
              throwOnError: false
            });
          });
          exp.dataset.rendered = '1';
        }
      });
    });

    // ==== å•é¡Œãƒã‚§ãƒƒã‚¯ï¼ˆé»„ãƒ»ç·‘ãƒ»èµ¤ï¼‰ ====
    async function toggleQuestionCheck(questionId, color, isChecked) {
      try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
        await fetch('/questions/' + questionId + '/check', {
          method: isChecked ? 'POST' : 'DELETE',
          headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': csrfToken },
          body: JSON.stringify({ color: color })
        });
      } catch (err) {
        console.error('ãƒã‚§ãƒƒã‚¯æ›´æ–°å¤±æ•—:', err);
      }
    }

    // ==== å›ç­”ãƒã‚§ãƒƒã‚¯ ====
    async function checkAnswer(blankId, selectedChoiceId) {
      try {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
        const response = await fetch("/questions/answer", {
          method: "POST",
          headers: { "Content-Type": "application/json", "X-CSRF-Token": csrfToken },
          body: JSON.stringify({
            blank_id: blankId,
            choice_id: selectedChoiceId
          })
        });
        const result = await response.json();

        const choiceButtons = document.querySelectorAll(`#choices_${blankId} .choice-btn`);
        choiceButtons.forEach(btn => {
          btn.style.backgroundColor = "";
          btn.style.borderColor = "#888";
        });

        const selectedBtn = document.getElementById(`btn_${blankId}_${selectedChoiceId}`);
        if (result.isCorrect) {
          selectedBtn.style.backgroundColor = "#c8facc";
          selectedBtn.style.borderColor = "green";
        } else {
          selectedBtn.style.backgroundColor = "#fdd";
          selectedBtn.style.borderColor = "red";

          // âœ… ä¸æ­£è§£æ™‚ã¯è§£èª¬ã‚’è‡ªå‹•å±•é–‹
          autoExpandExplanation(blankId);
        }

        const resultArea = document.getElementById(`result_${blankId}`);
        resultArea.innerHTML = result.isCorrect
          ? "<span style='color: green; font-weight:bold;'>ã€‡ æ­£è§£</span>"
          : "<span style='color: red; font-weight:bold;'>Ã— ä¸æ­£è§£</span>";
        resultArea.style.display = "block";

        // âœ… ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º
        showOverlay(result.isCorrect);

      } catch (err) {
        console.error("ç­”ãˆãƒã‚§ãƒƒã‚¯å¤±æ•—:", err);
      }
    }

    // ==== ä¸æ­£è§£æ™‚ã«è§£èª¬ã‚’è‡ªå‹•å±•é–‹ã™ã‚‹é–¢æ•° ====
    function autoExpandExplanation(blankId) {
      // SECURITY: blankIdã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã—ã¦CSS selector injection ã‚’é˜²æ­¢
      // IDã¯è‹±æ•°å­—ã€ãƒã‚¤ãƒ•ãƒ³ã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿è¨±å¯
      const sanitizedBlankId = String(blankId).replace(/[^A-Za-z0-9\-_]/g, '');

      if (!sanitizedBlankId) {
        console.error('Invalid blank_id:', blankId);
        return;
      }

      // æ—¢ã«å±•é–‹ã•ã‚Œã¦ã„ã‚‹è§£èª¬ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€åˆã®ä¸æ­£è§£ã®ã¿å±•é–‹ï¼‰
      const allExplanations = document.querySelectorAll('.blank-explanation');
      const alreadyExpanded = Array.from(allExplanations).some(exp => exp.style.display === 'block');

      if (alreadyExpanded) return;

      // ã‚µãƒ‹ã‚¿ã‚¤ã‚ºã•ã‚ŒãŸIDã‚’ä½¿ç”¨ã—ã¦DOMè¦ç´ ã‚’å–å¾—
      const exp = document.getElementById('explanation_' + sanitizedBlankId);
      const btn = document.querySelector(`.toggle-explanation-btn[data-blank="${sanitizedBlankId}"]`);

      if (!exp || !btn) {
        console.warn('Explanation or button not found for blank_id:', sanitizedBlankId);
        return;
      }

      // è§£èª¬ã‚’å±•é–‹
      exp.style.display = 'block';
      btn.textContent = 'è§£èª¬ã‚’éš ã™';

      // åˆå›è¡¨ç¤ºæ™‚ã«KaTeXã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
      if (!exp.dataset.rendered) {
        exp.querySelectorAll('.latex-content').forEach(function(elem) {
          renderMathInElement(elem, {
            delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\[', right: '\\]', display: true},
              {left: '\\(', right: '\\)', display: false}
            ],
            throwOnError: false
          });
        });
        exp.dataset.rendered = '1';
      }

      // è§£èª¬ã‚¨ãƒªã‚¢ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’è¨­å®š
      setTimeout(() => {
        exp.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        exp.setAttribute('tabindex', '-1');
        exp.focus();
      }, 100);
    }

    // ==== ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•° ====
    function showOverlay(isCorrect) {
      const overlay = document.getElementById("overlay");
      overlay.className = "overlay " + (isCorrect ? "correct" : "incorrect");
      overlay.style.display = "flex";

      setTimeout(() => {
        overlay.style.display = "none";
      }, 1800);
    }

    // ==== æ¬¡ã®å•é¡Œ ====
    function goNextQuestion() {
      const next = "<%= nextId %>";
      if (next) window.location.href = "/questions/" + next;
    }

    // ==== çµ‚äº†æ™‚ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•° ====
    async function showCompletionOverlay() {
      const messages = [
        "ãŒã‚“ã°ã‚Šã¾ã—ãŸï¼",
        "ãŠã¤ã‹ã‚Œã•ã¾ï¼",
        "ã‚ˆãã§ãã¾ã—ãŸï¼",
        "ã™ã°ã‚‰ã—ã„ï¼",
        "å®Œèµ°ãŠã‚ã§ã¨ã†ï¼"
      ];
      const randomMessage = messages[Math.floor(Math.random() * messages.length)];

      document.getElementById("completionMessage").textContent = randomMessage;
      document.getElementById("completionOverlay").style.display = "flex";

      // é”æˆåº¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤º
      try {
        const res = await fetch("/questions/completion-stats");
        const data = await res.json();
        if (data.categories && data.categories.length > 0) {
          renderAchievementBars(data.categories);
        }
      } catch (e) {
        console.error("é”æˆåº¦ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—:", e);
      }
    }

    // ==== é”æˆåº¦ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’æç”»ã™ã‚‹é–¢æ•° ====
    function renderAchievementBars(categories) {
      const container = document.getElementById("completionAchievement");

      // å¤§ã‚«ãƒ†ã‚´ãƒªã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const grouped = {};
      categories.forEach(cat => {
        if (!grouped[cat.large_category_name]) {
          grouped[cat.large_category_name] = [];
        }
        grouped[cat.large_category_name].push(cat);
      });

      let html = '<div class="completion-achievement-title">ã‚«ãƒ†ã‚´ãƒªåˆ¥ é”æˆåº¦</div>';
      let barIndex = 0;

      Object.entries(grouped).forEach(([largeName, smalls]) => {
        html += '<div class="completion-large-category">';
        html += '<div class="completion-large-header">' + escapeHtml(largeName) + '</div>';
        html += '<div class="completion-small-list">';

        smalls.forEach(cat => {
          const barId = 'cbar-' + barIndex;
          const diff = cat.after_accuracy - cat.before_accuracy;
          const diffText = cat.before_total > 0 && diff !== 0
            ? (diff > 0 ? '+' + diff : String(diff))
            : '';

          html += '<div class="completion-small-item">';
          html += '  <div class="completion-cat-name">' + escapeHtml(cat.small_category_name) + '</div>';
          html += '  <div class="completion-bar-wrapper">';
          html += '    <div class="completion-bar-track">';
          // beforeãƒãƒ¼ï¼ˆæ·¡ã„è‰²ã€ä¸‹å±¤ï¼‰
          html += '      <div class="completion-bar-before" id="' + barId + '-before" style="width:0%"></div>';
          // afterãƒãƒ¼ï¼ˆãƒ¡ã‚¤ãƒ³è‰²ã€ä¸Šå±¤ï¼‰
          html += '      <div class="completion-bar-after" id="' + barId + '-after" style="width:0%"></div>';
          html += '    </div>';
          html += '    <div class="completion-bar-labels">';
          html += '      <span class="completion-bar-percent" id="' + barId + '-pct">0%</span>';
          if (diffText) {
            const diffClass = diff > 0 ? 'positive' : 'negative';
            html += '      <span class="completion-bar-diff ' + diffClass + '" id="' + barId + '-diff" style="opacity:0">' + diffText + '</span>';
          }
          html += '    </div>';
          html += '  </div>';
          html += '</div>';
          barIndex++;
        });

        html += '</div></div>';
      });

      // å‡¡ä¾‹
      html += '<div class="completion-legend">';
      html += '  <span class="completion-legend-item"><span class="completion-legend-color before"></span>è§£ãå‰</span>';
      html += '  <span class="completion-legend-item"><span class="completion-legend-color after"></span>è§£ã„ãŸå¾Œ</span>';
      html += '</div>';

      container.innerHTML = html;

      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
      let idx = 0;
      Object.values(grouped).forEach(smalls => {
        smalls.forEach(cat => {
          const barId = 'cbar-' + idx;
          animateBar(barId, cat, idx);
          idx++;
        });
      });
    }

    // ==== å€‹åˆ¥ãƒãƒ¼ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ====
    function animateBar(barId, cat, index) {
      const beforeEl = document.getElementById(barId + '-before');
      const afterEl = document.getElementById(barId + '-after');
      const pctEl = document.getElementById(barId + '-pct');
      const diffEl = document.getElementById(barId + '-diff');
      if (!beforeEl || !afterEl) return;

      const stagger = index * 200;

      // Step1: beforeãƒãƒ¼ã‚’è¡¨ç¤ºï¼ˆ0.4så¾Œï¼‰
      setTimeout(() => {
        beforeEl.style.width = cat.before_accuracy + '%';
        if (pctEl) animateCounter(pctEl, 0, cat.before_accuracy, 400);
      }, 400 + stagger);

      // Step2: afterãƒãƒ¼ã‚’è¡¨ç¤ºï¼ˆ1.0så¾Œï¼‰
      setTimeout(() => {
        afterEl.style.width = cat.after_accuracy + '%';
        if (pctEl) animateCounter(pctEl, cat.before_accuracy, cat.after_accuracy, 500);
        // å·®åˆ†ãƒ©ãƒ™ãƒ«ã‚’ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
        if (diffEl) {
          setTimeout(() => { diffEl.style.opacity = '1'; }, 500);
        }
      }, 1000 + stagger);
    }

    // ==== æ•°å€¤ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ====
    function animateCounter(el, from, to, duration) {
      const start = performance.now();
      function update(now) {
        const elapsed = now - start;
        const progress = Math.min(elapsed / duration, 1);
        const value = Math.round(from + (to - from) * progress);
        el.textContent = value + '%';
        if (progress < 1) requestAnimationFrame(update);
      }
      requestAnimationFrame(update);
    }

    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(str) {
      const div = document.createElement('div');
      div.appendChild(document.createTextNode(str));
      return div.innerHTML;
    }

    // ==== çµ‚äº†ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’é–‰ã˜ã‚‹é–¢æ•° ====
    function closeCompletionOverlay() {
      document.getElementById("completionOverlay").style.display = "none";
      // å‡ºé¡Œã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰é¸æŠç”»é¢ã¸æˆ»ã‚‹
      const csrfToken2 = document.querySelector('meta[name="csrf-token"]').content;
      fetch("/questions/complete", {
        method: "POST",
        headers: { "Content-Type": "application/json", "X-CSRF-Token": csrfToken2 }
      })
        .then(() => {
          window.location.href = "/questions/select";
        })
        .catch(() => {
          window.location.href = "/questions/select";
        });
    }

  </script>
</body>
</html>