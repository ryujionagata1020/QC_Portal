<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <%- include("../_share/metadata.ejs") %>
  <title>å•é¡Œ <%= question_id %></title>
  <!-- å¤–éƒ¨CSSã‚’ä½¿ã†å ´åˆ -->
  <link rel="stylesheet" href="https://unpkg.com/ress/dist/ress.min.css" />
  <!-- è‡ªå‰CSSè¨­å®š -->
  <link rel="stylesheet" href="/public/index.css">
</head>

<body>
  <%- include("../_share/navbar.ejs") %>

  <main class="question-container">
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ»æ–°è¦ç™»éŒ²ãƒœã‚¿ãƒ³ -->
    <div class="auth-button-container">
      <% if (isAuthenticated) { %>
        <span class="user-info">ã‚ˆã†ã“ãã€<%= user.user_id %> ã•ã‚“</span>
        <button class="btn-auth" onclick="handleLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      <% } else { %>
        <button class="btn-auth" onclick="openAuthModal()">ãƒ­ã‚°ã‚¤ãƒ³ãƒ»æ–°è¦ç™»éŒ²</button>
      <% } %>
    </div>

    <% if (typeof currentNumber !== 'undefined' && typeof totalCount !== 'undefined') { %>
      <div class="question-progress-container">
        <div class="question-progress"><%= currentNumber %>å•ç›® / <%= totalCount %>å•ä¸­</div>
      </div>
    <% } %>
    <div class="question-header">
      <h2>å•é¡ŒIDï¼š<%= question_id %></h2>
    </div>
    <div class="meta">
      <div>ã‚«ãƒ†ã‚´ãƒªï¼š<%= large_category_name %> ï¼ <%= small_category_name %></div>
      <div>é›£æ˜“åº¦ï¼š<%= testlevel %>ç´š</div>
    </div>

    <% if (image_data) { %>
      <div class="img-area">
        <img src="/public/<%= image_data %>" alt="å•é¡Œå›³" width="400">
      </div>
    <% } %>

    <div class="body">
      <p><%= body %></p>
    </div>

    <div class="blanks-area">
      <% blanks.forEach(function(blank) { %>
        <div class="blank-block">
          <div class="blank-header">
            <h3>ï¼ˆ<%= blank.blank_number %>ï¼‰</h3>
            <span id="result_<%= blank.blank_id %>" class="resultArea"></span>
          </div>
          <div class="choice-grid" id="choices_<%= blank.blank_id %>">
            <% choices.forEach(function(choice) { %>
              <div class="choice-cell">
                <button class="choice-btn"
                        id="btn_<%= blank.blank_id %>_<%= choice.choice_id %>"
                        onclick="checkAnswer('<%= blank.blank_id %>', '<%= choice.choice_id %>')">
                  <%= choice.label %>
                </button>
                <span><%= choice.text %></span>
              </div>
            <% }); %>
          </div>
        </div>
      <% }); %>
    </div>

    <button class="btn" id="toggleExplanation">è§£èª¬ã‚’ã¿ã‚‹</button>
    <div id="explanation" style="display:none;"><%= explanation %></div>

    <div class="next-button-container">
      <% if (nextId) { %>
        <button type="button" class="btn-next" onclick="goNextQuestion()">æ¬¡ã®å•é¡Œã¸</button>
      <% } else { %>
        <button type="button" class="btn-next" onclick="showCompletionOverlay()">ã“ã‚Œã§çµ‚äº†ã§ã™</button>
      <% } %>
    </div>

    <!-- âœ… ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="overlay" class="overlay">
      <div class="overlay-content" id="overlayMessage"></div>
    </div>

    <!-- çµ‚äº†æ™‚ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="completionOverlay" class="completion-overlay">
      <div class="completion-content">
        <div class="completion-icon">ğŸ‰</div>
        <div class="completion-message" id="completionMessage"></div>
        <button class="btn-completion-close" onclick="closeCompletionOverlay()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </main>

  <!-- èªè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="authModal" class="auth-modal">
    <div class="auth-modal-content">
      <span class="auth-modal-close" onclick="closeAuthModal()">&times;</span>

      <!-- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ -->
      <div class="auth-tabs">
        <button class="auth-tab active" onclick="switchAuthTab('login')">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <button class="auth-tab" onclick="switchAuthTab('register')">æ–°è¦ç™»éŒ²</button>
      </div>

      <!-- ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div id="loginForm" class="auth-form-container active">
        <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
        <form id="loginFormElement" onsubmit="handleLogin(event)">
          <div class="form-group">
            <label for="login-user_id">ãƒ¦ãƒ¼ã‚¶ãƒ¼ID</label>
            <input type="text" id="login-user_id" name="user_id" required>
          </div>
          <div class="form-group">
            <label for="login-password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="password" id="login-password" name="password" required>
          </div>
          <div class="form-group checkbox-group">
            <label>
              <input type="checkbox" id="rememberMe" name="rememberMe">
              ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ä¿æŒã™ã‚‹ï¼ˆ1ãƒ¶æœˆï¼‰
            </label>
          </div>
          <div class="form-group">
            <button type="submit" class="btn-submit">ãƒ­ã‚°ã‚¤ãƒ³</button>
          </div>
          <div id="loginMessage" class="auth-message"></div>
        </form>
        <div class="auth-footer">
          <a href="#" class="forgot-password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãŠå¿˜ã‚Œã®å ´åˆ</a>
        </div>
      </div>

      <!-- æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div id="registerForm" class="auth-form-container">
        <h2>æ–°è¦ç™»éŒ²</h2>
        <form id="registerFormElement" onsubmit="handleRegister(event)">
          <div class="form-group">
            <label for="register-user_id">ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆ4ã€œ50æ–‡å­—ï¼‰</label>
            <input type="text" id="register-user_id" name="user_id" minlength="4" maxlength="50" required>
          </div>
          <div class="form-group">
            <label for="register-password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ8æ–‡å­—ä»¥ä¸Šï¼‰</label>
            <input type="password" id="register-password" name="password" minlength="8" required>
          </div>
          <div class="form-group">
            <label for="register-mail">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä»»æ„ï¼‰</label>
            <input type="email" id="register-mail" name="mail">
          </div>
          <div class="form-group">
            <button type="submit" class="btn-submit">ç™»éŒ²</button>
          </div>
          <div id="registerMessage" class="auth-message"></div>
        </form>
      </div>
    </div>
  </div>

  <%- include("../_share/footer.ejs") %>

  <script>
    // ==== è§£èª¬ã®é–‹é–‰ ====
    const exp = document.getElementById("explanation");
    const toggleBtn = document.getElementById("toggleExplanation");
    toggleBtn.addEventListener("click", () => {
      const show = exp.style.display === "none";
      exp.style.display = show ? "block" : "none";
      toggleBtn.textContent = show ? "è§£èª¬ã‚’éš ã™" : "è§£èª¬ã‚’ã¿ã‚‹";
    });

    // ==== å›ç­”ãƒã‚§ãƒƒã‚¯ ====
    async function checkAnswer(blankId, selectedChoiceId) {
      try {
        const response = await fetch("/questions/answer", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            blank_id: blankId,
            choice_id: selectedChoiceId
          })
        });
        const result = await response.json();

        const choiceButtons = document.querySelectorAll(`#choices_${blankId} .choice-btn`);
        choiceButtons.forEach(btn => {
          btn.style.backgroundColor = "";
          btn.style.borderColor = "#888";
        });

        const selectedBtn = document.getElementById(`btn_${blankId}_${selectedChoiceId}`);
        if (result.isCorrect) {
          selectedBtn.style.backgroundColor = "#c8facc";
          selectedBtn.style.borderColor = "green";
        } else {
          selectedBtn.style.backgroundColor = "#fdd";
          selectedBtn.style.borderColor = "red";
        }

        const resultArea = document.getElementById(`result_${blankId}`);
        resultArea.innerHTML = result.isCorrect
          ? "<span style='color: green; font-weight:bold;'>ã€‡ æ­£è§£</span>"
          : "<span style='color: red; font-weight:bold;'>Ã— ä¸æ­£è§£</span>";
        resultArea.style.display = "block";

        // âœ… ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º
        showOverlay(result.isCorrect);

      } catch (err) {
        console.error("ç­”ãˆãƒã‚§ãƒƒã‚¯å¤±æ•—:", err);
      }
    }

    // ==== ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•° ====
    function showOverlay(isCorrect) {
      const overlay = document.getElementById("overlay");
      overlay.className = "overlay " + (isCorrect ? "correct" : "incorrect");
      overlay.style.display = "flex";

      setTimeout(() => {
        overlay.style.display = "none";
      }, 1800);
    }

    // ==== æ¬¡ã®å•é¡Œ ====
    function goNextQuestion() {
      const next = "<%= nextId %>";
      if (next) window.location.href = "/questions/" + next;
    }

    // ==== çµ‚äº†æ™‚ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•° ====
    function showCompletionOverlay() {
      const messages = [
        "ãŒã‚“ã°ã‚Šã¾ã—ãŸï¼",
        "ãŠã¤ã‹ã‚Œã•ã¾ï¼",
        "ã‚ˆãã§ãã¾ã—ãŸï¼",
        "ã™ã°ã‚‰ã—ã„ï¼",
        "å®Œèµ°ãŠã‚ã§ã¨ã†ï¼"
      ];
      const randomMessage = messages[Math.floor(Math.random() * messages.length)];

      document.getElementById("completionMessage").textContent = randomMessage;
      document.getElementById("completionOverlay").style.display = "flex";
    }

    // ==== çµ‚äº†ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’é–‰ã˜ã‚‹é–¢æ•° ====
    function closeCompletionOverlay() {
      document.getElementById("completionOverlay").style.display = "none";
      window.location.href = "/questions/select";
    }

    // ==== èªè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ ====
    function openAuthModal() {
      document.getElementById('authModal').style.display = 'block';
    }

    function closeAuthModal() {
      document.getElementById('authModal').style.display = 'none';
      clearAuthMessages();
    }

    function switchAuthTab(tab) {
      const tabs = document.querySelectorAll('.auth-tab');
      const forms = document.querySelectorAll('.auth-form-container');

      tabs.forEach(t => t.classList.remove('active'));
      forms.forEach(f => f.classList.remove('active'));

      if (tab === 'login') {
        tabs[0].classList.add('active');
        document.getElementById('loginForm').classList.add('active');
      } else {
        tabs[1].classList.add('active');
        document.getElementById('registerForm').classList.add('active');
      }

      clearAuthMessages();
    }

    function clearAuthMessages() {
      document.getElementById('loginMessage').textContent = '';
      document.getElementById('registerMessage').textContent = '';
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹
    window.onclick = function(event) {
      const modal = document.getElementById('authModal');
      if (event.target === modal) {
        closeAuthModal();
      }
    }

    // ==== ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† ====
    async function handleLogin(event) {
      event.preventDefault();
      const form = event.target;
      const user_id = form.user_id.value;
      const password = form.password.value;
      const rememberMe = form.rememberMe.checked;

      try {
        const response = await fetch('/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id, password, rememberMe })
        });

        const data = await response.json();
        const messageEl = document.getElementById('loginMessage');

        if (data.success) {
          messageEl.textContent = data.message;
          messageEl.style.color = 'green';
          setTimeout(() => {
            location.reload();
          }, 1000);
        } else {
          messageEl.textContent = data.message;
          messageEl.style.color = 'red';
        }
      } catch (error) {
        console.error('Login error:', error);
        document.getElementById('loginMessage').textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
        document.getElementById('loginMessage').style.color = 'red';
      }
    }

    // ==== æ–°è¦ç™»éŒ²å‡¦ç† ====
    async function handleRegister(event) {
      event.preventDefault();
      const form = event.target;
      const user_id = form.user_id.value;
      const password = form.password.value;
      const mail = form.mail.value;

      try {
        const response = await fetch('/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id, password, mail })
        });

        const data = await response.json();
        const messageEl = document.getElementById('registerMessage');

        if (data.success) {
          messageEl.textContent = data.message;
          messageEl.style.color = 'green';
          form.reset();
          setTimeout(() => {
            switchAuthTab('login');
          }, 2000);
        } else {
          messageEl.textContent = data.message;
          messageEl.style.color = 'red';
        }
      } catch (error) {
        console.error('Register error:', error);
        document.getElementById('registerMessage').textContent = 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
        document.getElementById('registerMessage').style.color = 'red';
      }
    }

    // ==== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç† ====
    async function handleLogout() {
      if (!confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;

      try {
        const response = await fetch('/auth/logout', {
          method: 'POST'
        });

        const data = await response.json();
        if (data.success) {
          location.reload();
        }
      } catch (error) {
        console.error('Logout error:', error);
      }
    }
  </script>
</body>
</html>