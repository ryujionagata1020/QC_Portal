<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">

  <!-- ✅ 共通メタデータ -->
  <%- include("../_share/metadata.ejs") %>

  <title>出題条件選択</title>
  <!-- 外部CSSを使う場合 -->
  <link rel="stylesheet" href="https://unpkg.com/ress/dist/ress.min.css" />
  <!-- 自前CSS設定 -->
  <link rel="stylesheet" href="/public/index.css">
</head>

<body>
  <!-- ✅ 共通ナビバー -->
  <%- include("../_share/navbar.ejs") %>

  <main class="select-container">
    <!--<h1>QC-Portal</h1>-->

    <!-- ペンギン画像＋吹き出し（ランダム） -->
    <% const penginImages = ['pengin_learning.png','pengin_bus.png','pengin_densya.png','pengin_ohuro.png','pengin_syokuji.png']; %>
    <% const penginSrc = penginImages[Math.floor(Math.random() * penginImages.length)]; %>
    <% const penginMessages = [
      'アカウント登録すると自分の成長具合がよく分かるようになるよ',
      '今日も頑張ろう！勉強も休憩も！',
      'ツール機能も使ってみてね！',
      '学習履歴で過去の正答率を確認しよう！',
      '電車やバスのスキマ時間も有効に使ってみて！',
      '問題に３つまでチェックを付けられるよ！'
    ]; %>
    <% const penginMessage = penginMessages[Math.floor(Math.random() * penginMessages.length)]; %>
    <div class="pengin-area">
      <img src="/public/<%= penginSrc %>" alt="QC-Portal" class="pengin-img">
      <div class="pengin-bubble"><%= penginMessage %></div>
    </div>

    <form id="selectForm" action="/questions/start" method="POST">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
      <!-- 出題条件選択エリア（横一列） -->
      <div class="selection-controls">
        <!-- 出題レベル選択 -->
        <div class="control-group">
          <div class="control-label">出題レベル</div>
          <div id="testLevelArea" class="checkbox-area">
            <label><input type="checkbox" name="testlevels" value="1"> 1級</label>
            <label><input type="checkbox" name="testlevels" value="2"> 2級</label>
            <label><input type="checkbox" name="testlevels" value="3"> 3級</label>
            <label><input type="checkbox" name="testlevels" value="4" checked> 4級</label>
          </div>
        </div>

        <!-- 出題範囲選択（カテゴリ反映用、フォーム送信対象外） -->
        <div class="control-group">
          <div class="control-label">出題範囲</div>
          <div id="examScopeArea" class="checkbox-area">
            <label><input type="checkbox" data-scope-filter="1" onclick="setScope(1)"> 1級</label>
            <label><input type="checkbox" data-scope-filter="2" onclick="setScope(2)"> 2級</label>
            <label><input type="checkbox" data-scope-filter="3" onclick="setScope(3)"> 3級</label>
            <label><input type="checkbox" data-scope-filter="4" onclick="setScope(4)" checked> 4級</label>
          </div>
        </div>

        <!-- 出題数選択 -->
        <div class="control-group">
          <div class="control-label">出題数</div>
          <div class="question-limit-area">
            <input type="range" id="questionLimitSlider" name="question_limit" min="1" max="101" value="101">
            <span id="questionLimitDisplay" class="question-limit-display">全問</span>
            <% if (typeof user !== 'undefined' && user) { %>
              <label class="unanswered-only-label">
                <input type="checkbox" name="unanswered_only" value="1">
                未回答のみ出題
              </label>
            <% } %>
          </div>
        </div>

      </div>

      <!-- 出題開始ボタン -->
      <div class="start-button-container">
        <button type="submit" class="btn-start">出題開始</button>
        <% if (typeof resumeData !== 'undefined' && resumeData) { %>
          <% if (resumeData.fromDb) { %>
            <a href="/questions/resume" class="btn-resume">
              中断したところから再開（<%= resumeData.currentNumber %>/<%= resumeData.totalCount %>問目から）
            </a>
          <% } else { %>
            <a href="/questions/<%= resumeData.questionId %>" class="btn-resume">
              中断したところから再開（<%= resumeData.currentNumber %>/<%= resumeData.totalCount %>問目から）
            </a>
          <% } %>
        <% } %>
      </div>

      <!-- カテゴリ選択 -->
      <div class="section-title-row">
        <div class="section-title">カテゴリ選択</div>
        <div class="action-buttons">
          <button type="button" class="btn-action" onclick="checkAll(true)">すべて選択</button>
          <button type="button" class="btn-action" onclick="checkAll(false)">すべて解除</button>
        </div>
      </div>

      <!-- カテゴリタブ -->
      <div class="category-tabs">
        <button type="button" class="category-tab active" data-tab="practical" onclick="switchCategoryTab('practical')">実践</button>
        <button type="button" class="category-tab" data-tab="methods" onclick="switchCategoryTab('methods')">手法</button>
      </div>

      <!-- 実践カテゴリ -->
      <div class="category-panel active" id="practicalPanel" data-panel="practical">
        <% (categoriesByType.practical || []).forEach(function(large){ %>
          <div class="large-category">
            <div class="large-header" id="header_<%= large.id %>">
              <label class="large-checkbox-label">
                <input type="checkbox" class="large-category-checkbox" data-large-id="<%= large.id %>" onchange="toggleLargeCategory('<%= large.id %>', this.checked)">
              </label>
              <span class="large-header-text"><%= large.name %></span>
            </div>
            <div id="small_<%= large.id %>" class="small-list">
              <% large.smalls.forEach(function(small){ %>
                <label data-scope="<%= small.scope_exam %>">
                  <input type="checkbox" name="smalls" value="<%= small.id %>">
                  <%= small.name %>（<%= small.scope_exam %>級から）
                </label><br>
              <% }); %>
            </div>
          </div>
        <% }); %>
      </div>

      <!-- 手法カテゴリ -->
      <div class="category-panel" id="methodsPanel" data-panel="methods">
        <% (categoriesByType.methods || []).forEach(function(large){ %>
          <div class="large-category">
            <div class="large-header" id="header_<%= large.id %>">
              <label class="large-checkbox-label">
                <input type="checkbox" class="large-category-checkbox" data-large-id="<%= large.id %>" onchange="toggleLargeCategory('<%= large.id %>', this.checked)">
              </label>
              <span class="large-header-text"><%= large.name %></span>
            </div>
            <div id="small_<%= large.id %>" class="small-list">
              <% large.smalls.forEach(function(small){ %>
                <label data-scope="<%= small.scope_exam %>">
                  <input type="checkbox" name="smalls" value="<%= small.id %>">
                  <%= small.name %>（<%= small.scope_exam %>級から）
                </label><br>
              <% }); %>
            </div>
          </div>
        <% }); %>
      </div>

            <!-- 出題開始ボタン -->
      <div class="start-button-container">
        <button type="submit" class="btn-start">出題開始</button>
        <% if (typeof resumeData !== 'undefined' && resumeData) { %>
          <% if (resumeData.fromDb) { %>
            <a href="/questions/resume" class="btn-resume">
              中断したところから再開（<%= resumeData.currentNumber %>/<%= resumeData.totalCount %>問目から）
            </a>
          <% } else { %>
            <a href="/questions/<%= resumeData.questionId %>" class="btn-resume">
              中断したところから再開（<%= resumeData.currentNumber %>/<%= resumeData.totalCount %>問目から）
            </a>
          <% } %>
        <% } %>
      </div>
    </form>

  </main>

  <!-- ✅ 共通フッター -->
  <%- include("../_share/footer.ejs") %>

  <script>
  // 現在選択中の出題範囲を保持
  let currentScope = 4;

  // === 出題数表示の更新（requestAnimationFrameでスムーズに） ===
  let updateQueued = false;

  function updateQuestionLimitDisplay(value) {
    if (updateQueued) return;

    updateQueued = true;
    requestAnimationFrame(() => {
      const display = document.getElementById("questionLimitDisplay");
      if (display) {
        if (parseInt(value) === 101) {
          display.textContent = "全問";
        } else {
          display.textContent = value + "問";
        }
      }
      updateQueued = false;
    });
  }

  // === 出題範囲（scope_exam）制御（カテゴリ反映専用） ===
  function setScope(selected) {
    currentScope = selected;

    // （1）単一選択（他のチェックを解除）
    document.querySelectorAll("input[data-scope-filter]").forEach(cb => {
      cb.checked = (parseInt(cb.dataset.scopeFilter, 10) === selected);
    });

    // 現在アクティブなパネルのみ対象にする
    const activePanel = document.querySelector(".category-panel.active");
    if (!activePanel) return;

    // （2）アクティブパネル内のすべてを未チェックにリセット
    activePanel.querySelectorAll("input[name='smalls']").forEach(cb => cb.checked = false);

    // （3）アクティブパネル内で該当 scope_exam を持つカテゴリをON
    activePanel.querySelectorAll("label[data-scope]").forEach(lbl => {
      const scopeValue = parseInt(lbl.dataset.scope, 10);
      const cb = lbl.querySelector("input");
      if (!cb) return;

      if (selected === 1 && [1, 2, 3, 4].includes(scopeValue)) cb.checked = true;
      else if (selected === 2 && [2, 3, 4].includes(scopeValue)) cb.checked = true;
      else if (selected === 3 && [3, 4].includes(scopeValue)) cb.checked = true;
      else if (selected === 4 && [4].includes(scopeValue)) cb.checked = true;
    });

    // （4）アクティブパネル内の大分類チェックボックスを更新
    activePanel.querySelectorAll(".large-category-checkbox").forEach(cb => {
      const largeId = cb.dataset.largeId;
      updateLargeCategoryCheckbox(largeId);
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    // ✅ 出題数スライダーのイベントリスナー設定
    const slider = document.getElementById("questionLimitSlider");
    if (slider) {
      // inputイベント（リアルタイム更新）
      slider.addEventListener("input", (e) => {
        updateQuestionLimitDisplay(e.target.value);
      });

      // changeイベント（確実性のため）
      slider.addEventListener("change", (e) => {
        updateQuestionLimitDisplay(e.target.value);
      });
    }

    // ✅ 初期化デフォルト：4級反映
    setScope(4);

    // ✅ 範囲チェックボックスのイベント設定
    document.querySelectorAll("input[data-scope-filter]").forEach(cb => {
      cb.addEventListener("change", ev => {
        if (ev.target.checked) {
          const selected = parseInt(ev.target.dataset.scopeFilter, 10);
          setScope(selected);
        }
      });
    });

    // ✅ 小分類チェックボックス変更時に大分類チェックボックスを更新
    document.querySelectorAll("input[name='smalls']").forEach(cb => {
      cb.addEventListener("change", () => {
        const section = cb.closest(".small-list");
        if (section && section.id.startsWith("small_")) {
          const largeId = section.id.replace("small_", "");
          updateLargeCategoryCheckbox(largeId);
        }
      });
    });
  });

  // === 大分類チェックボックスで小分類をすべてチェック/解除 ===
  function toggleLargeCategory(largeId, checked) {
    const section = document.getElementById("small_" + largeId);
    if (!section) return;
    section.querySelectorAll("input[name='smalls']").forEach(cb => {
      cb.checked = checked;
    });
  }

  // === 小分類のチェック状態に応じて大分類チェックボックスを更新 ===
  function updateLargeCategoryCheckbox(largeId) {
    const section = document.getElementById("small_" + largeId);
    const largeCheckbox = document.querySelector(`input.large-category-checkbox[data-large-id="${largeId}"]`);
    if (!section || !largeCheckbox) return;

    const smallCheckboxes = section.querySelectorAll("input[name='smalls']");
    const checkedCount = section.querySelectorAll("input[name='smalls']:checked").length;

    if (checkedCount === 0) {
      largeCheckbox.checked = false;
      largeCheckbox.indeterminate = false;
    } else if (checkedCount === smallCheckboxes.length) {
      largeCheckbox.checked = true;
      largeCheckbox.indeterminate = false;
    } else {
      largeCheckbox.checked = false;
      largeCheckbox.indeterminate = true;
    }
  }

  // === カテゴリ全選択・全解除 ===
  function checkAll(flag) {
    // 現在アクティブなパネルのみ対象
    const activePanel = document.querySelector(".category-panel.active");
    if (activePanel) {
      activePanel.querySelectorAll("input[name='smalls']").forEach(cb => cb.checked = flag);
      activePanel.querySelectorAll(".large-category-checkbox").forEach(cb => {
        cb.checked = flag;
        cb.indeterminate = false;
      });
    }
  }

  // === カテゴリタブ切り替え ===
  function switchCategoryTab(tab) {
    // タブボタンの切り替え
    document.querySelectorAll(".category-tab").forEach(btn => {
      btn.classList.toggle("active", btn.dataset.tab === tab);
    });
    // パネルの切り替え
    document.querySelectorAll(".category-panel").forEach(panel => {
      panel.classList.toggle("active", panel.dataset.panel === tab);
    });
    // 現在のscope設定を新しいアクティブパネルに適用
    setScope(currentScope);
  }


</script>
</body>
</html>